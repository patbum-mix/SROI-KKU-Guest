
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SROI Platform Demo - ทดลองใช้งาน</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Demo Mode - ไม่ต้อง login
        var currentProjectId = null;
        var DEMO_MODE = true;
    </script>
    <style>
        /* ===== LOGIN PAGE STYLES - HIDDEN ===== */
        #login-page {
            display: none !important;
        }
        
        /* ===== SROI SYSTEM STYLES ===== */
        #sroi-system {
            display: block !important;
        }
        :root {
            --primary: #a73b24;
            --primary-light: #c4512f;
            --secondary: #d4a227;
            --secondary-light: #e5b835;
            --accent: #38a169;
            --danger: #e53e3e;
            --bg-gradient: linear-gradient(135deg, #8b2f1d 0%, #a73b24 30%, #c4512f 70%, #8b2f1d 100%);
            --card-bg: white;
            --shadow: 0 10px 40px rgba(167, 59, 36, 0.15);
            --shadow-hover: 0 20px 60px rgba(167, 59, 36, 0.25);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: #e8ecf0;
            min-height: 100vh;
            color: #2d3748;
        }

        /* Header */
        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 3rem;
            background: rgba(0, 0, 0, 0.1);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .logo-text h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .logo-text p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-header {
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.35);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.4), 0 2px 6px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(4px);
        }

        .btn-header:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-logout {
            background: rgba(220, 53, 69, 0.3);
            border-color: rgba(220, 53, 69, 0.5);
        }

        .btn-logout:hover {
            background: rgba(220, 53, 69, 0.5);
            border-color: rgba(220, 53, 69, 0.8);
        }

        /* Language Toggle Button */
        .btn-language {
            background: linear-gradient(180deg, rgba(56, 161, 105, 0.4) 0%, rgba(56, 161, 105, 0.2) 100%);
            border-color: rgba(56, 161, 105, 0.5);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-language:hover {
            background: rgba(56, 161, 105, 0.5);
            border-color: rgba(56, 161, 105, 0.8);
        }

        .btn-language .lang-text {
            font-weight: 600;
        }

        /* Hide Google Translate elements */
        .goog-te-banner-frame, .goog-te-balloon-frame {
            display: none !important;
        }
        
        body {
            top: 0 !important;
        }
        
        .goog-te-gadget {
            display: none !important;
        }
        
        .skiptranslate {
            display: none !important;
        }

        #google_translate_element {
            display: none !important;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            padding: 0 3rem;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-bottom: none;
            color: rgba(255, 255, 255, 0.85);
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            border-radius: 12px 12px 0 0;
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-tab.active {
            color: var(--primary);
            background: var(--card-bg);
        }

        .nav-tab i {
            margin-right: 0.5rem;
        }

        /* Main Content */
        .main-content {
            padding: 2rem 3rem 4rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .card-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #718096;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .form-label .required {
            color: var(--danger);
            margin-left: 0.25rem;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(167, 59, 36, 0.1);
        }

        .form-control::placeholder {
            color: #a0aec0;
        }

        select.form-control {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23718096'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.25rem;
            padding-right: 3rem;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Other Input Container */
        .other-input-container {
            display: none;
            margin-top: 0.75rem;
        }

        .other-input-container.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Date Range */
        .date-range {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .date-range span {
            color: #718096;
            font-weight: 500;
        }

        /* SDG Checkboxes */
        .sdg-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 0.75rem;
        }

        .sdg-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #e8ecf0;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .sdg-item:hover {
            background: #edf2f7;
        }

        .sdg-item.selected {
            background: linear-gradient(135deg, rgba(167, 59, 36, 0.1), rgba(196, 81, 47, 0.1));
            border-color: var(--primary);
        }

        .sdg-item input {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .sdg-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .sdg-label {
            font-size: 0.80rem;
            color: #4a5568;
        }

        /* SDG Color Codes */
        .sdg-1 .sdg-number { background: #E5243B; }
        .sdg-2 .sdg-number { background: #DDA63A; }
        .sdg-3 .sdg-number { background: #4C9F38; }
        .sdg-4 .sdg-number { background: #C5192D; }
        .sdg-5 .sdg-number { background: #FF3A21; }
        .sdg-6 .sdg-number { background: #26BDE2; }
        .sdg-7 .sdg-number { background: #FCC30B; }
        .sdg-8 .sdg-number { background: #A21942; }
        .sdg-9 .sdg-number { background: #FD6925; }
        .sdg-10 .sdg-number { background: #DD1367; }
        .sdg-11 .sdg-number { background: #FD9D24; }
        .sdg-12 .sdg-number { background: #BF8B2E; }
        .sdg-13 .sdg-number { background: #3F7E44; }
        .sdg-14 .sdg-number { background: #0A97D9; }
        .sdg-15 .sdg-number { background: #56C02B; }
        .sdg-16 .sdg-number { background: #00689D; }
        .sdg-17 .sdg-number { background: #19486A; }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(167, 59, 36, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(167, 59, 36, 0.4);
        }

        .btn-secondary {
            background: #edf2f7;
            color: var(--primary);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            box-shadow: 0 4px 15px rgba(56, 161, 105, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(56, 161, 105, 0.4);
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(201, 162, 39, 0.3);
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(201, 162, 39, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-gradient);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 500;
            white-space: nowrap;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        tr:hover {
            background: #e8ecf0;
        }

        tr:last-child td {
            border-bottom: none;
        }
        
        /* ===== Changes Table Specific Styles ===== */
        #changesTableWrapper th,
        #changesTableWrapper td {
            padding: 0.6rem 0.5rem;
            font-size: 0.85rem;
        }
        
        #changesTableWrapper th {
            white-space: normal;
            line-height: 1.3;
        }
        
        /* กำหนดขนาดคอลัมน์ของตาราง Changes */
        #changesTableWrapper th:nth-child(1),
        #changesTableWrapper td:nth-child(1) { width: 35px; text-align: center; } /* # */
        
        #changesTableWrapper th:nth-child(2),
        #changesTableWrapper td:nth-child(2) { min-width: 100px; max-width: 130px; } /* Stakeholder */
        
        #changesTableWrapper th:nth-child(3),
        #changesTableWrapper td:nth-child(3) { width: 70px; } /* จำนวน/หน่วย */
        
        #changesTableWrapper th:nth-child(4),
        #changesTableWrapper td:nth-child(4) { min-width: 90px; max-width: 120px; } /* Input */
        
        #changesTableWrapper th:nth-child(5),
        #changesTableWrapper td:nth-child(5) { width: 85px; } /* มูลค่า Input */
        
        #changesTableWrapper th:nth-child(6),
        #changesTableWrapper td:nth-child(6) { width: 70px; } /* ประเภท Outcome */
        
        #changesTableWrapper th:nth-child(7),
        #changesTableWrapper td:nth-child(7) { min-width: 90px; max-width: 120px; } /* Outcome */
        
        #changesTableWrapper th:nth-child(8),
        #changesTableWrapper td:nth-child(8) { min-width: 80px; max-width: 100px; } /* ตัวชี้วัด */
        
        #changesTableWrapper th:nth-child(9),
        #changesTableWrapper td:nth-child(9) { min-width: 80px; max-width: 100px; } /* Financial Proxy */
        
        #changesTableWrapper th:nth-child(10),
        #changesTableWrapper td:nth-child(10) { width: 95px; } /* มูลค่า Y0-Y5 */
        
        #changesTableWrapper th:nth-child(11),
        #changesTableWrapper td:nth-child(11) { width: 75px; } /* Adjustments */
        
        #changesTableWrapper th:nth-child(12),
        #changesTableWrapper td:nth-child(12) { width: 70px; } /* Drop-off */
        
        #changesTableWrapper th:nth-child(13),
        #changesTableWrapper td:nth-child(13) { width: 70px; text-align: center; } /* จัดการ */
        
        #changesTableWrapper td {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* ตารางบน container ให้ไม่ต้อง scroll */
        .changes-table-container {
            overflow-x: visible;
        }
        
        .changes-table-container table {
            table-layout: fixed;
            width: 100%;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-edit {
            background: #edf2f7;
            color: var(--primary);
        }

        .btn-edit:hover {
            background: var(--primary);
            color: white;
        }

        .btn-delete {
            background: #fed7d7;
            color: var(--danger);
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        /* Sub-tabs */
        .sub-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: #e8ecf0;
            padding: 0.5rem;
            border-radius: 12px;
        }

        .sub-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Prompt', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            color: #718096;
            cursor: pointer;
            transition: var(--transition);
        }

        .sub-tab:hover {
            color: var(--primary);
            background: white;
        }

        .sub-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .sub-content {
            display: none;
        }

        .sub-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* Year Grid */
        .year-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .year-input {
            text-align: center;
        }

        .year-label {
            display: block;
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        /* Percent Input */
        .percent-input {
            position: relative;
        }

        .percent-input input {
            padding-right: 2.5rem;
        }

        .percent-input::after {
            content: '%';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-weight: 500;
        }

        /* Results Section */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: var(--transition);
        }

        .result-card.highlight {
            background: var(--bg-gradient);
            color: white;
            border: none;
        }

        .result-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .result-card.highlight .result-icon {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .result-label {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            opacity: 0.9;
        }

        .result-value {
            font-family: 'Kanit', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .result-unit {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        /* Summary Actions */
        .summary-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            padding: 2rem;
            background: #e8ecf0;
            border-radius: var(--border-radius);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: #e8ecf0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: #e2e8f0;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(167, 59, 36, 0.1);
            color: var(--primary);
        }

        .badge-success {
            background: rgba(56, 161, 105, 0.1);
            color: var(--accent);
        }

        .badge-warning {
            background: rgba(201, 162, 39, 0.1);
            color: var(--secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #718096;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .nav-tabs {
                padding: 0 1rem;
                overflow-x: auto;
            }

            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            .main-content {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .date-range {
                flex-direction: column;
            }

            .summary-actions {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }

        /* Print Styles */
        /* Print Styles */
        @media print {
            .header, .nav-tabs, .btn, .section-nav, .summary-actions, .add-btn-container, .btn-nav {
                display: none !important;
            }

            .card {
                box-shadow: none;
                break-inside: avoid;
            }
            
            body {
                background: white !important;
            }
            
            .main-content {
                padding: 0 !important;
            }
            
            .section {
                display: block !important;
            }
            
            /* แสดงเฉพาะ section4 (สรุปผล) ในหน้าพิมพ์ */
            #section1, #section2, #section3 {
                display: none !important;
            }
            
            #section4 {
                display: block !important;
            }
            
            /* ปรับขนาดให้พอดี 1 หน้า */
            @page {
                size: A4;
                margin: 1cm;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e8ecf0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 0.75rem;
            z-index: 3000;
            animation: slideUp 0.3s ease-out;
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            background: var(--accent);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Add Button Float */
        .add-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        /* File Upload Styles */
        .file-upload-container {
            position: relative;
        }
        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .file-preview i {
            font-size: 24px;
        }
        .file-preview .text-danger {
            color: #dc3545;
        }
        .btn-remove-file {
            margin-left: auto;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-remove-file:hover {
            background: #ff6b7a;
        }
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #6c757d;
        }
        .required-star {
            color: #dc3545;
            font-weight: bold;
        }
        input[type="file"] {
            padding: 8px;
        }
        input[type="file"]::-webkit-file-upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        input[type="file"]::-webkit-file-upload-button:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        /* Navigation Buttons */
        .section-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }
        .section-nav.end {
            justify-content: flex-end;
        }
        .section-nav.start {
            justify-content: flex-start;
        }
        .btn-nav {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-next {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4);
        }
        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.5);
        }
        .btn-prev {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4);
        }
        .btn-prev:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.5);
        }
    </style>
</head>
<body>

    <!-- Google Translate Element (Hidden) -->
    <div id="google_translate_element" style="display:none;"></div>

    <!-- ===== LOGIN PAGE ===== -->
    <div id="login-page">
        <div id="login-wrapper">
            <img id="login-bg" src="login-bg.png">
            <div class="login-overlay">
                <button class="overlay-btn" id="btn-login-kku" onclick="doLogin()" title="Login KKU"></button>
                <button class="overlay-btn" id="btn-thaid" onclick="doLogin()" title="เข้าสู่ระบบด้วย ThaiID"></button>
                <input type="text" class="overlay-input" id="input-username" placeholder="Username">
                <input type="password" class="overlay-input" id="input-password" placeholder="Password">
                <button class="overlay-btn" id="btn-submit" onclick="doLogin()" title="เข้าสู่ระบบ"></button>
            </div>
        </div>
    </div>

    <!-- ===== SROI SYSTEM ===== -->
    <div id="sroi-system">
    <header class="header">
        <div class="header-top">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="logo-text">
                    <h1>SROI Platform</h1>
                    <p>มหาวิทยาลัยขอนแก่น | Khon Kaen University</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-header" onclick="goToDashboard()">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </button>
                <button class="btn-header" onclick="resetForm()">
                    <i class="fas fa-redo"></i> เริ่มใหม่
                </button>
                <button class="btn-header" onclick="saveData()">
                    <i class="fas fa-save"></i> บันทึกข้อมูล
                </button>
                <button class="btn-header btn-language" onclick="toggleLanguage()" id="langToggleBtn" title="Switch Language">
                    <i class="fas fa-globe"></i>
                    <span class="lang-text" id="langText">EN</span>
                </button>
                <a href="https://sroi.kku.ac.th" class="btn-header" style="background: linear-gradient(135deg, #38a169, #2f855a); text-decoration: none;">
                    <i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบจริง
                </a>
            </div>
        </div>
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('section1', this)">
                <i class="fas fa-file-alt"></i> ข้อมูลโครงการ
            </button>
            <button class="nav-tab" onclick="showSection('section2', this)">
                <i class="fas fa-cogs"></i> SROI Controller
            </button>
            <button class="nav-tab" onclick="showSection('section3', this)">
                <i class="fas fa-calculator"></i> ผลการคำนวณ
            </button>
            <button class="nav-tab" onclick="showSection('section4', this)">
                <i class="fas fa-award"></i> สรุปผล
            </button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Section 1: ข้อมูลโครงการ -->
        <section id="section1" class="section active">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div>
                        <h2 class="card-title">ข้อมูลทั่วไปของโครงการ</h2>
                        <p class="card-subtitle">กรอกรายละเอียดเกี่ยวกับโครงการที่ต้องการประเมิน SROI</p>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group full-width">
                        <label class="form-label">ชื่อโครงการ <span class="required">*</span></label>
                        <input type="text" class="form-control" id="projectName" placeholder="กรอกชื่อโครงการ">
                    </div>

                    <div class="form-group">
                        <label class="form-label">วันที่บันทึก</label>
                        <input type="date" class="form-control" id="recordDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ชื่อผู้บันทึก</label>
                        <input type="text" class="form-control" id="recorderName" placeholder="กรอกชื่อผู้บันทึก">
                    </div>

                    <div class="form-group">
                        <label class="form-label">งบประมาณโครงการ (บาท) <span class="required">*</span></label>
                        <input type="number" class="form-control" id="budget" placeholder="0.00" min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">รูปแบบโครงการ</label>
                        <select class="form-control" id="projectType" onchange="toggleOtherInput('projectType', 'projectTypeOther')">
                            <option value="">-- เลือกรูปแบบโครงการ --</option>
                            <option value="โครงการสังคม">โครงการสังคม</option>
                            <option value="โครงการเศรษฐกิจ">โครงการเศรษฐกิจ</option>
                            <option value="โครงการสิ่งแวดล้อม">โครงการสิ่งแวดล้อม</option>
                            <option value="โครงการผสม">โครงการผสม</option>
                            <option value="other">อื่นๆ (ระบุ)</option>
                        </select>
                        <div class="other-input-container" id="projectTypeOther">
                            <input type="text" class="form-control" id="projectTypeOtherValue" placeholder="ระบุรูปแบบโครงการ">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">หน่วยงานที่รับผิดชอบ</label>
                        <select class="form-control" id="department" onchange="toggleOtherInput('department', 'departmentOther')">
                            <option value="">-- เลือกหน่วยงาน --</option>
                            <!-- Options will be populated by JavaScript -->
                            <option value="other">อื่นๆ (ระบุ)</option>
                        </select>
                        <div class="other-input-container" id="departmentOther">
                            <input type="text" class="form-control" id="departmentOtherValue" placeholder="ระบุหน่วยงาน">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ยุทธศาสตร์</label>
                        <select class="form-control" id="strategy" onchange="toggleOtherInput('strategy', 'strategyOther')">
                            <option value="">-- เลือกยุทธศาสตร์ --</option>
                            <!-- Options will be populated by JavaScript -->
                            <option value="other">อื่นๆ (ระบุ)</option>
                        </select>
                        <div class="other-input-container" id="strategyOther">
                            <input type="text" class="form-control" id="strategyOtherValue" placeholder="ระบุยุทธศาสตร์">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">รูปแบบการประเมิน</label>
                        <select class="form-control" id="evaluationType" onchange="toggleOtherInput('evaluationType', 'evaluationTypeOther')">
                            <option value="">-- เลือกรูปแบบการประเมิน --</option>
                            <option value="ประเมินก่อนดำเนินโครงการ (Ex-Ante Evaluation)">ประเมินก่อนดำเนินโครงการ (Ex-Ante Evaluation)</option>
                            <option value="ประเมินระหว่างดำเนินโครงการ (On-going Evaluation)">ประเมินระหว่างดำเนินโครงการ (On-going Evaluation)</option>
                            <option value="ประเมินหลังดำเนินโครงการ (Ex-post Evaluation)">ประเมินหลังดำเนินโครงการ (Ex-post Evaluation)</option>
                            <option value="other">อื่นๆ (ระบุ)</option>
                        </select>
                        <div class="other-input-container" id="evaluationTypeOther">
                            <input type="text" class="form-control" id="evaluationTypeOtherValue" placeholder="ระบุรูปแบบการประเมิน">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">วัตถุประสงค์</label>
                        <textarea class="form-control" id="objectives" placeholder="กรอกวัตถุประสงค์ของโครงการ"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ผลผลิต</label>
                        <textarea class="form-control" id="expectedResults" placeholder="กรอกผลผลิตของโครงการ"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ระยะเวลาดำเนินโครงการ</label>
                        <div class="date-range">
                            <input type="date" class="form-control" id="startDate">
                            <span>ถึง</span>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ข้อเสนอโครงการ (ไฟล์ PDF เท่านั้น)</label>
                        <div class="file-upload-container">
                            <input type="file" class="form-control" id="proposalFile" accept=".pdf" onchange="validatePDF(this, 'proposal')">
                            <small class="form-text text-muted"><i class="fas fa-info-circle"></i> อัปโหลดไฟล์ .PDF เท่านั้น (ไม่บังคับ)</small>
                            <div id="proposalFilePreview" class="file-preview" style="display: none;">
                                <i class="fas fa-file-pdf text-danger"></i>
                                <span id="proposalFileName"></span>
                                <button type="button" class="btn-remove-file" onclick="removeFile('proposal')"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">รายงานฉบับสมบูรณ์ (ไฟล์ PDF เท่านั้น)</label>
                        <div class="file-upload-container">
                            <input type="file" class="form-control" id="reportFile" accept=".pdf" onchange="validatePDF(this, 'report')">
                            <small class="form-text text-muted"><i class="fas fa-info-circle"></i> อัปโหลดไฟล์ .PDF เท่านั้น (ไม่บังคับ)</small>
                            <div id="reportFilePreview" class="file-preview" style="display: none;">
                                <i class="fas fa-file-pdf text-danger"></i>
                                <span id="reportFileName"></span>
                                <button type="button" class="btn-remove-file" onclick="removeFile('report')"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">เบอร์โทรติดต่อ <span class="required-star">*</span></label>
                        <input type="tel" class="form-control" id="phoneNumber" placeholder="กรอกเบอร์โทรติดต่อ เช่น 0812345678" required pattern="[0-9]{9,10}" maxlength="10">
                        <small class="form-text text-muted"><i class="fas fa-info-circle"></i> กรุณากรอกเบอร์โทรศัพท์ 9-10 หลัก (บังคับกรอก)</small>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div>
                        <h2 class="card-title">เป้าหมายการพัฒนาที่ยั่งยืน (SDGs)</h2>
                        <p class="card-subtitle">เลือก SDG ที่โครงการเกี่ยวข้อง (สามารถเลือกได้มากกว่า 1 ข้อ)</p>
                    </div>
                </div>

                <div class="sdg-container" id="sdgContainer">
                    <!-- SDG checkboxes will be populated by JavaScript -->
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="section-nav end">
                <button class="btn-nav btn-next" onclick="showSection('section2', document.querySelectorAll('.nav-tab')[1])">
                    ถัดไป <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Section 2: SROI Controller -->
        <section id="section2" class="section">
            <!-- Stakeholders -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h2 class="card-title">Stakeholders (ผู้มีส่วนได้ส่วนเสีย)</h2>
                        <p class="card-subtitle">จัดการข้อมูลผู้มีส่วนได้ส่วนเสียในโครงการ</p>
                    </div>
                </div>

                <div class="add-btn-container">
                    <button class="btn btn-primary" onclick="openStakeholderModal()">
                        <i class="fas fa-plus"></i> เพิ่ม Stakeholder
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>ชื่อ Stakeholder</th>
                                <th>ประเภท</th>
                                <th>จำนวน</th>
                                <th>หน่วย</th>
                                <th>รายละเอียด</th>
                                <th style="width: 100px;">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="stakeholderTable">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <h3>ยังไม่มีข้อมูล Stakeholder</h3>
                                        <p>คลิกปุ่ม "เพิ่ม Stakeholder" เพื่อเริ่มต้น</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Changes -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div>
                        <h2 class="card-title">Changes (การเปลี่ยนแปลง)</h2>
                        <p class="card-subtitle">จัดการข้อมูล Input, Outcome และการปรับค่า</p>
                    </div>
                </div>

                <div class="add-btn-container">
                    <button class="btn btn-primary" onclick="openChangeModal()">
                        <i class="fas fa-plus"></i> เพิ่ม Change
                    </button>
                </div>

                <div class="table-container changes-table-container">
                    <table id="changesTableWrapper">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Stakeholder</th>
                                <th>จำนวน/หน่วย</th>
                                <th>Input</th>
                                <th>มูลค่า Input</th>
                                <th>ประเภท Outcome</th>
                                <th>Outcome</th>
                                <th>ตัวชี้วัด</th>
                                <th>Financial Proxy</th>
                                <th>มูลค่า Y0-Y5</th>
                                <th>Adj.</th>
                                <th>Drop</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="changesTable">
                            <tr>
                                <td colspan="13">
                                    <div class="empty-state">
                                        <i class="fas fa-exchange-alt"></i>
                                        <h3>ยังไม่มีข้อมูล Change</h3>
                                        <p>คลิกปุ่ม "เพิ่ม Change" เพื่อเริ่มต้น</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="section-nav">
                <button class="btn-nav btn-prev" onclick="showSection('section1', document.querySelectorAll('.nav-tab')[0])">
                    <i class="fas fa-arrow-left"></i> ย้อนกลับ
                </button>
                <button class="btn-nav btn-next" onclick="showSection('section3', document.querySelectorAll('.nav-tab')[2])">
                    ถัดไป <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Section 3: ผลการคำนวณ -->
        <section id="section3" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div>
                        <h2 class="card-title">ผลการคำนวณ SROI</h2>
                        <p class="card-subtitle">คำนวณผลตอบแทนทางสังคมจากการลงทุน</p>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 2rem;">
                    <button class="btn btn-success btn-lg" onclick="calculateSROI()" style="padding: 1rem 3rem; font-size: 1.1rem;">
                        <i class="fas fa-play"></i> คำนวณ SROI
                    </button>
                </div>

                <div class="results-grid">
                    <div class="result-card highlight">
                        <div class="result-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="result-label">SROI Ratio</div>
                        <div class="result-value" id="sroiRatio">-</div>
                        <div class="result-unit">มูลค่าผลตอบแทนต่อเงินลงทุน 1 บาท</div>
                    </div>

                    <div class="result-card">
                        <div class="result-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="result-label">Total Present Value</div>
                        <div class="result-value" id="totalPV">-</div>
                        <div class="result-unit">มูลค่าปัจจุบันรวม (บาท)</div>
                    </div>

                    <div class="result-card">
                        <div class="result-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="result-label">Total Investment</div>
                        <div class="result-value" id="totalInvestment">-</div>
                        <div class="result-unit">เงินลงทุนรวม (บาท)</div>
                    </div>

                    <div class="result-card">
                        <div class="result-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="result-label">Net Benefit</div>
                        <div class="result-value" id="netBenefit">-</div>
                        <div class="result-unit">ผลต่างสุทธิของประโยชน์ (บาท)</div>
                    </div>
                </div>

                <!-- Outcome Mapping Table -->
                <div class="card" style="background: white; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">
                        <i class="fas fa-map"></i> Outcome Mapping
                    </h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ปัจจัยนำเข้า (Input)</th>
                                    <th>กิจกรรม</th>
                                    <th>ผลผลิต</th>
                                    <th>ผู้มีส่วนได้ส่วนเสีย</th>
                                    <th>ผลลัพธ์ (Outcome)</th>
                                </tr>
                            </thead>
                            <tbody id="outcomeMappingTable">
                                <tr>
                                    <td colspan="5">
                                        <div class="empty-state" style="padding: 1rem;">
                                            <i class="fas fa-info-circle"></i>
                                            <p>กรุณาคำนวณ SROI เพื่อแสดงข้อมูล</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="background: white;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">
                        <i class="fas fa-info-circle"></i> สูตรการคำนวณ SROI
                    </h3>
                    <div style="font-family: monospace; background: white; padding: 1.5rem; border-radius: 10px; overflow-x: auto;">
                        <p style="margin-bottom: 0.5rem;"><strong>SROI Ratio</strong> = Total Present Value / Total Investment</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Net Benefit</strong> = Total Present Value - Total Investment</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Adjusted Value</strong> = Impact × (1 - Deadweight) × (1 - Displacement) × (1 - Attribution)</p>
                        <p><strong>Present Value (Yn)</strong> = Adjusted Value × (1 - Drop-off)^n / (1 + Discount Rate)^n</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="section-nav">
                <button class="btn-nav btn-prev" onclick="showSection('section2', document.querySelectorAll('.nav-tab')[1])">
                    <i class="fas fa-arrow-left"></i> ย้อนกลับ
                </button>
                <button class="btn-nav btn-next" onclick="showSection('section4', document.querySelectorAll('.nav-tab')[3])">
                    ถัดไป <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Section 4: สรุปผล -->
        <section id="section4" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-award"></i>
                    </div>
                    <div>
                        <h2 class="card-title">สรุปผลการประเมิน SROI</h2>
                        <p class="card-subtitle">ดาวน์โหลดใบรับรองและส่งออกข้อมูล</p>
                    </div>
                </div>

                <div class="summary-actions">
                    <button class="btn btn-gold" onclick="downloadCertificate()">
                        <i class="fas fa-certificate"></i> ดาวน์โหลดใบรับรอง (TH)
                    </button>
                    <button class="btn btn-gold" onclick="downloadCertificateEN()" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                        <i class="fas fa-certificate"></i> Download Certificate (EN)
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> ส่งออกข้อมูล Excel
                    </button>
                    <button class="btn btn-primary" onclick="printReport()">
                        <i class="fas fa-print"></i> พิมพ์รายงาน
                    </button>
                </div>

                <div id="summaryContent" style="margin-top: 2rem;">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>กรุณาคำนวณ SROI ก่อน</h3>
                        <p>ไปที่แท็บ "ผลการคำนวณ" และคลิกปุ่ม "คำนวณ SROI"</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="section-nav start">
                <button class="btn-nav btn-prev" onclick="showSection('section3', document.querySelectorAll('.nav-tab')[2])">
                    <i class="fas fa-arrow-left"></i> ย้อนกลับ
                </button>
            </div>
        </section>
    </main>

    <!-- Stakeholder Modal -->
    <div class="modal-overlay" id="stakeholderModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="stakeholderModalTitle">เพิ่ม Stakeholder</h3>
                <button class="modal-close" onclick="closeStakeholderModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="stakeholderEditIndex" value="-1">
                
                <div class="form-group">
                    <label class="form-label">ชื่อ Stakeholder <span class="required">*</span></label>
                    <input type="text" class="form-control" id="stakeholderName" placeholder="กรอกชื่อ Stakeholder">
                </div>

                <div class="form-group">
                    <label class="form-label">ประเภท</label>
                    <select class="form-control" id="stakeholderType" onchange="toggleOtherInput('stakeholderType', 'stakeholderTypeOther')">
                        <option value="">-- เลือกประเภท --</option>
                        <option value="ผู้รับประโยชน์โดยตรง">ผู้รับประโยชน์โดยตรง</option>
                        <option value="ผู้ดำเนินงานหลัก">ผู้ดำเนินงานหลัก</option>
                        <option value="หน่วยงานสนับสนุนงบประมาณ">หน่วยงานสนับสนุนงบประมาณ</option>
                        <option value="กลุ่ม/หน่วยงานที่เกี่ยวข้อง">กลุ่ม/หน่วยงานที่เกี่ยวข้อง</option>
                        <option value="other">อื่นๆ (ระบุ)</option>
                    </select>
                    <div class="other-input-container" id="stakeholderTypeOther">
                        <input type="text" class="form-control" id="stakeholderTypeOtherValue" placeholder="ระบุประเภท">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">จำนวน</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" class="form-control" id="stakeholderCount" placeholder="0" min="0" style="flex: 1;">
                        <select class="form-control" id="stakeholderUnit" style="flex: 1;" onchange="toggleOtherInput('stakeholderUnit', 'stakeholderUnitOther')">
                            <option value="คน">คน</option>
                            <option value="ชุมชน">ชุมชน</option>
                            <option value="หน่วยงาน">หน่วยงาน</option>
                            <option value="other">อื่นๆ (ระบุ)</option>
                        </select>
                    </div>
                    <div class="other-input-container" id="stakeholderUnitOther">
                        <input type="text" class="form-control" id="stakeholderUnitOtherValue" placeholder="ระบุหน่วย">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">รายละเอียด</label>
                    <textarea class="form-control" id="stakeholderDetail" placeholder="กรอกรายละเอียดเพิ่มเติม"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStakeholderModal()">ยกเลิก</button>
                <button class="btn btn-primary" onclick="saveStakeholder()">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Change Modal -->
    <div class="modal-overlay" id="changeModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="changeModalTitle">เพิ่ม Change</h3>
                <button class="modal-close" onclick="closeChangeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="changeEditIndex" value="-1">
                
                <div class="form-group">
                    <label class="form-label">เลือก Stakeholder <span class="required">*</span></label>
                    <select class="form-control" id="changeStakeholder">
                        <option value="">-- เลือก Stakeholder --</option>
                    </select>
                </div>

                <div class="sub-tabs">
                    <button class="sub-tab active" onclick="showSubTab('inputTab', this)">
                        <i class="fas fa-sign-in-alt"></i> Input
                    </button>
                    <button class="sub-tab" onclick="showSubTab('outcomeTab', this)">
                        <i class="fas fa-sign-out-alt"></i> Outcome
                    </button>
                    <button class="sub-tab" onclick="showSubTab('adjustTab', this)">
                        <i class="fas fa-sliders-h"></i> Adjust
                    </button>
                </div>

                <!-- Input Tab -->
                <div class="sub-content active" id="inputTab">
                    <div class="form-group">
                        <label class="form-label">ปัจจัยนำเข้า (Input)</label>
                        <textarea class="form-control" id="inputDescription" placeholder="อธิบายปัจจัยนำเข้า"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">มูลค่าทางการเงิน Input (บาท)</label>
                        <div class="year-grid">
                            <div class="year-input">
                                <span class="year-label">Y0</span>
                                <input type="number" class="form-control" id="inputValueY0" placeholder="0" min="0" step="0.01">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y1</span>
                                <input type="number" class="form-control" id="inputValueY1" placeholder="0" min="0" step="0.01">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y2</span>
                                <input type="number" class="form-control" id="inputValueY2" placeholder="0" min="0" step="0.01">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y3</span>
                                <input type="number" class="form-control" id="inputValueY3" placeholder="0" min="0" step="0.01">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y4</span>
                                <input type="number" class="form-control" id="inputValueY4" placeholder="0" min="0" step="0.01">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y5</span>
                                <input type="number" class="form-control" id="inputValueY5" placeholder="0" min="0" step="0.01">
                            </div>
                        </div>
                        <small class="form-text text-muted"><i class="fas fa-info-circle"></i> กรอกมูลค่าแยกตามปี (ไม่บังคับ) - ระบบจะรวมทั้งหมดเพื่อคำนวณ</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">รายละเอียดเพิ่มเติม</label>
                        <textarea class="form-control" id="inputAdditionalDetails" placeholder="กรอกรายละเอียดเพิ่มเติม (ไม่บังคับ)"></textarea>
                    </div>
                </div>

                <!-- Outcome Tab -->
                <div class="sub-content" id="outcomeTab">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">ประเภท Outcome</label>
                            <select class="form-control" id="outcomeCategory" onchange="updateOutcomeOptions(); toggleOtherInput('outcomeCategory', 'outcomeCategoryOther')">
                                <option value="">-- เลือกประเภท --</option>
                                <option value="เศรษฐกิจ">เศรษฐกิจ</option>
                                <option value="สังคม">สังคม</option>
                                <option value="สิ่งแวดล้อม">สิ่งแวดล้อม</option>
                                <option value="other">อื่นๆ (ระบุ)</option>
                            </select>
                            <div class="other-input-container" id="outcomeCategoryOther">
                                <input type="text" class="form-control" id="outcomeCategoryOtherValue" placeholder="ระบุประเภท Outcome">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Outcome (ผลลัพธ์)</label>
                            <select class="form-control" id="outcomeType" onchange="toggleOtherInput('outcomeType', 'outcomeTypeOther')">
                                <option value="">-- เลือก Outcome --</option>
                                <option value="other">อื่นๆ (ระบุ)</option>
                            </select>
                            <div class="other-input-container" id="outcomeTypeOther">
                                <input type="text" class="form-control" id="outcomeTypeOtherValue" placeholder="ระบุ Outcome">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ตัวชี้วัด (Indicator)</label>
                        <input type="text" class="form-control" id="indicator" placeholder="กรอกตัวชี้วัด">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ค่าแทนทางการเงิน (Financial Proxy)</label>
                        <input type="text" class="form-control" id="financialProxy" placeholder="กรอกค่าแทนทางการเงิน">
                    </div>

                    <div class="form-group">
                        <label class="form-label">มูลค่าทางการเงินตามปี (บาท)</label>
                        <div class="year-grid">
                            <div class="year-input">
                                <span class="year-label">Y0</span>
                                <input type="number" class="form-control" id="outcomeY0" placeholder="0" min="0">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y1</span>
                                <input type="number" class="form-control" id="outcomeY1" placeholder="0" min="0">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y2</span>
                                <input type="number" class="form-control" id="outcomeY2" placeholder="0" min="0">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y3</span>
                                <input type="number" class="form-control" id="outcomeY3" placeholder="0" min="0">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y4</span>
                                <input type="number" class="form-control" id="outcomeY4" placeholder="0" min="0">
                            </div>
                            <div class="year-input">
                                <span class="year-label">Y5</span>
                                <input type="number" class="form-control" id="outcomeY5" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Adjust Tab -->
                <div class="sub-content" id="adjustTab">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Dead Weight (ผลลัพธ์ส่วนเกิน)</label>
                            <div class="percent-input">
                                <input type="number" class="form-control" id="deadWeight" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Displacement (ผลลัพธ์ทดแทน)</label>
                            <div class="percent-input">
                                <input type="number" class="form-control" id="displacement" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Attribution (ผลลัพธ์จากปัจจัยอื่น)</label>
                            <div class="percent-input">
                                <input type="number" class="form-control" id="attribution" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Discount Rate (อัตราคิดลด)</label>
                            <div class="percent-input">
                                <input type="number" class="form-control" id="discountRate" placeholder="3.5" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Drop-off Rate (อัตราการลดลงรายปี)</label>
                        <div class="year-grid">
                            <div class="year-input">
                                <span class="year-label">ปีที่ 1</span>
                                <div class="percent-input">
                                    <input type="number" class="form-control" id="dropoff1" placeholder="0" min="0" max="100" step="0.1">
                                </div>
                            </div>
                            <div class="year-input">
                                <span class="year-label">ปีที่ 2</span>
                                <div class="percent-input">
                                    <input type="number" class="form-control" id="dropoff2" placeholder="0" min="0" max="100" step="0.1">
                                </div>
                            </div>
                            <div class="year-input">
                                <span class="year-label">ปีที่ 3</span>
                                <div class="percent-input">
                                    <input type="number" class="form-control" id="dropoff3" placeholder="0" min="0" max="100" step="0.1">
                                </div>
                            </div>
                            <div class="year-input">
                                <span class="year-label">ปีที่ 4</span>
                                <div class="percent-input">
                                    <input type="number" class="form-control" id="dropoff4" placeholder="0" min="0" max="100" step="0.1">
                                </div>
                            </div>
                            <div class="year-input">
                                <span class="year-label">ปีที่ 5</span>
                                <div class="percent-input">
                                    <input type="number" class="form-control" id="dropoff5" placeholder="0" min="0" max="100" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeChangeModal()">ยกเลิก</button>
                <button class="btn btn-primary" onclick="saveChange()">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">บันทึกข้อมูลสำเร็จ</span>
    </div>

    <!-- Hidden Canvas for Certificate -->
    <canvas id="certificateCanvas" style="display: none;"></canvas>

    </div>

    <script>
        // Login function
        function doLogin() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('sroi-system').style.display = 'block';
            document.body.style.overflow = 'auto';
        }
        
        // Go to Dashboard
        function goToDashboard() {
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                showToast('🎮 Demo Mode - กรุณาเข้าสู่ระบบจริงเพื่อใช้งาน Dashboard', 'info');
                return;
            }
            window.location.href = 'dashboard.html';
        }
        
        // Logout function
        function doLogout() {
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                showToast('🎮 Demo Mode - คุณไม่ได้ login อยู่', 'info');
                return;
            }
            localStorage.removeItem('sroiUser');
            localStorage.removeItem('sroiToken');
            localStorage.removeItem('sroiLoggedIn');
            localStorage.removeItem('sroiStayLoggedIn');
            window.location.href = 'login.html';
        }
    </script>

    <script>
        // ===== Data Storage =====
        let stakeholders = [];
        let changes = [];
        let sroiResult = null;

        // ===== Dropdown Data =====
        const departments = [
            // ฝ่าย
            "ฝ่ายบริหาร",
            "ฝ่ายการศึกษาและดิจิทัล",
            "ฝ่ายการต่างประเทศ",
            "ฝ่ายวิจัยและนวัตกรรม",
            "ฝ่ายกายภาพและสิ่งแวดล้อม",
            "ฝ่ายวิสาหกิจและสังคมยั่งยืน",
            "ฝ่ายศิลปวัฒนธรรมและเศรษฐกิจสร้างสรรค์",
            "ฝ่ายทรัพยากรบุคคล",
            "ฝ่ายกิจการนักศึกษาและนวัตวณิชย์",
            "ฝ่ายกฎหมายและสื่อสารองค์กร",
            // สำนักงานสภามหาวิทยาลัย
            "สำนักงานสภามหาวิทยาลัย",
            // สำนักงานอธิการบดี
            "กองตรวจสอบภายใน",
            "กองกฎหมาย",
            "กองการกีฬา",
            "กองการต่างประเทศ",
            "กองคลัง",
            "กองสาธารณูปโภค และสิ่งแวดล้อม",
            "กองทรัพยากรบุคคล",
            "กองบริการหอพักนักศึกษา",
            "กองบริหารงานกลาง",
            "กองบริหารงานวิจัย",
            "กองป้องกันและรักษาความปลอดภัย",
            "กองพัฒนาคุณภาพการศึกษา",
            "กองพัฒนานักศึกษาและศิษย์เก่าสัมพันธ์",
            "กองยุทธศาสตร์",
            "กองสื่อสารองค์กร",
            "กองอาคารและสถานที่",
            "สถาบันการสอนวิชาศึกษาทั่วไป",
            "สถาบันขงจื่อ",
            "สถาบันภาษา",
            "สถาบันเคเคยูอะคาเดมี่ (KKU Academy)",
            "สถาบันวิจัยความมั่นคงด้านอาหาร พลังงาน น้ำอนุภูมิภาคลุ่มน้ำโขง",
            "สถาบันวิจัยเพื่อพัฒนาสังคม",
            "สถาบันวิจัยวิจัยมะเร็งท่อน้ำดี",
            "สถาบันวิจัยยุทธศาสตร์และประสานความร่วมมือเพื่อพัฒนาภาคตะวันออกเฉียงเหนือ",
            "สถาบันวิจัยและพัฒนาวิชาชีพครูสำหรับอาเซียน มหาวิทยาลัยขอนแก่น",
            "สถาบันวิจัยวิทยาศาสตร์สุขภาพลุ่มน้ำโขง",
            "สถาบันวิจัยเพื่อพัฒนาสมรรถนะมนุษย์และการสร้างเสริมสุขภาพ",
            "สถาบันวิจัยและบริการออทิซึม",
            "สถาบันวิจัยและนวัตกรรมวัสดุนาโนเพื่อพลังงาน",
            "สถาบันวิจัยแคนนาบิสครบศาสตร์ มหาวิทยาลัยขอนแก่น",
            "ศูนย์ทรัพย์สินทางปัญญา",
            "ศูนย์นวัตกรรมการเรียนการสอน",
            "ศูนย์จริยธรรมการวิจัยในมนุษย์",
            "ศูนย์ประสานงานโครงการอันเนื่องมาจากพระราชดำริ",
            "ศูนย์ศิลปวัฒนธรรม",
            "ศูนย์สัตว์ทดลองภาคตะวันเฉียงเหนือ",
            "ศูนย์อาเซียนศึกษา",
            "ศูนย์พิพิธภัณฑ์และแหล่งเรียนรู้ตลอดชีวิต",
            "ศูนย์บริหารเทคโนโลยีและนวัตกรรม",
            "ศูนย์บริหารเวลเนสและเขตนวัตกรรมทางการแพทย์ มหาวิทยาลัยขอนแก่น",
            "ศูนย์จัดการระบบสารสนเทศเพื่อการบริหารทั่วทั้งองค์กร (ERP)",
            "ศูนย์เคเคยู เอนเตอร์ไพรส์ (KKU Enterprise)",
            "สถาบันฟีโนมแห่งชาติ มหาวิทยาลัยขอนแก่น",
            "ศูนย์กำกับดูแลการดำเนินการต่อสัตว์เพื่องานทางวิทยาศาสตร์ มหาวิทยาลัยขอนแก่น",
            "โรงพิมพ์มหาวิทยาลัยขอนแก่น",
            "ศูนย์บริหารจัดการด้านโรงแรม (บายาสิตา@เคเคยู)",
            "ศูนย์บริการสู่ชุมชน มหาวิทยาลัยขอนแก่น",
            "ศูนย์สื่อการเรียนรู้",
            "อุทยานวิทยาศาสตร์ มหาวิทยาลัยขอนแก่น",
            "โรงงานแบตเตอรี่และพลังงานยุคใหม่",
            "ศูนย์ปลูกและสกัดกัญชง-กัญชามหาวิทยาลัยขอนแก่น",
            "ศูนย์บริหารจัดการทรัพย์สิน มหาวิทยาลัยขอนแก่น",
            "ศูนย์เซลล์บำบัดรักษา มหาวิทยาลัยขอนแก่น",
            // คณะ
            "คณะเกษตรศาสตร์",
            "คณะทันตแพทยศาสตร์",
            "คณะเทคนิคการแพทย์",
            "คณะเทคโนโลยี",
            "คณะนิติศาสตร์",
            "คณะบริหารธุรกิจและการบัญชี",
            "คณะพยาบาลศาสตร์",
            "คณะแพทยศาสตร์",
            "คณะเภสัชศาสตร์",
            "คณะมนุษยศาสตร์และสังคมศาสตร์",
            "คณะวิทยาศาสตร์",
            "คณะวิศวกรรมศาสตร์",
            "คณะศิลปกรรมศาสตร์",
            "คณะศึกษาศาสตร์",
            "คณะเศรษฐศาสตร์",
            "คณะสถาปัตยกรรมศาสตร์",
            "คณะสหวิทยาการ",
            "คณะสัตวแพทยศาสตร์",
            "คณะสาธารณสุขศาสตร์",
            // วิทยาลัย
            "บัณฑิตวิทยาลัย",
            "วิทยาลัยการคอมพิวเตอร์",
            "วิทยาลัยการปกครองท้องถิ่น",
            "วิทยาลัยนานาชาติ",
            "วิทยาลัยบัณฑิตศึกษาการจัดการ",
            // สำนัก
            "สำนักเทคโนโลยีดิจิทัล",
            "สำนักบริการวิชาการ",
            "สำนักบริหารและพัฒนาวิชาการ",
            "สำนักหอสมุด"
        ];

        const strategies = [
            "ยุทธศาสตร์ 1 การปรับเปลี่ยนทางด้านการศึกษา (Education Transformation)",
            "ยุทธศาสตร์ 2 ปรับเปลี่ยนการทำงานวิจัย (Research Transformation)",
            "ยุทธศาสตร์ 3 การนำมหาวิทยาลัยสู่ความเป็นนานาชาติ (Internationalization)",
            "ยุทธศาสตร์ 4 สร้างมหาวิทยาลัยให้เป็นที่น่าทำงาน (Best Place to Work)",
            "ยุทธศาสตร์ 5 สร้างมหาวิทยาลัยให้เป็นที่น่าอยู่ (Great Place to Live)",
            "ยุทธศาสตร์ 6 การบริหารตามหลักธรรมาภิบาลที่ดีและการชี้นำสังคม (Beyond Good Governance)",
            "ยุทธศาสตร์ 7 ปรับเปลี่ยนการบริหารจัดการทรัพยากรบุคคล (Human Resource Management Transformation)",
            "ยุทธศาสตร์ 8 การเป็นมหาวิทยาลัยที่มีสมรรถนะสูง (High Performing University)",
            "ยุทธศาสตร์ 9 การเป็นมหาวิทยาลัยดิจิทัล (Digital University)",
            "ยุทธศาสตร์ 10 การบริการวิชาการเพื่อสร้างประโยชน์ให้สังคม (Societal Contribution)",
            "ยุทธศาสตร์ 11 เสริมสร้างความร่วมมือเพื่อพัฒนา (Collaboration & Coordination for Development)"
        ];

        const sdgList = [
            { id: 1, name: "ขจัดความยากจน" },
            { id: 2, name: "ขจัดความหิวโหย" },
            { id: 3, name: "สุขภาพและความเป็นอยู่ที่ดี" },
            { id: 4, name: "การศึกษาที่มีคุณภาพ" },
            { id: 5, name: "ความเท่าเทียมทางเพศ" },
            { id: 6, name: "น้ำสะอาดและการสุขาภิบาล" },
            { id: 7, name: "พลังงานสะอาดที่เข้าถึงได้" },
            { id: 8, name: "งานที่มีคุณค่าและการเติบโตทางเศรษฐกิจ" },
            { id: 9, name: "โครงสร้างพื้นฐาน นวัตกรรม และอุตสาหกรรม" },
            { id: 10, name: "ลดความเหลื่อมล้ำ" },
            { id: 11, name: "เมืองและชุมชนที่ยั่งยืน" },
            { id: 12, name: "การผลิตและบริโภคที่ยั่งยืน" },
            { id: 13, name: "การรับมือกับการเปลี่ยนแปลงสภาพภูมิอากาศ" },
            { id: 14, name: "ทรัพยากรทางทะเล" },
            { id: 15, name: "ระบบนิเวศบนบก" },
            { id: 16, name: "สันติภาพ ความยุติธรรม และสถาบันที่เข้มแข็ง" },
            { id: 17, name: "ความร่วมมือเพื่อการพัฒนาที่ยั่งยืน" }
        ];

        // Outcome Data
        const outcomeEconomic = [
            "การเพิ่มรายได้",
            "การเพิ่มการจ้างงาน",
            "การเพิ่มยอดขายสินค้าและบริการ",
            "การเพิ่มผลผลิตทางการเกษตร",
            "การเพิ่มความสามารถในการเข้าถึงตลาด",
            "การเพิ่มความสามารถในการแข่งขันของธุรกิจ",
            "การลดต้นทุนการผลิต",
            "การส่งเสริมการท่องเที่ยว",
            "การส่งเสริมการลงทุน",
            "การเพิ่มการส่งออกสินค้าและบริการ",
            "การส่งเสริมธุรกิจขนาดกลางและขนาดย่อม (SMEs)",
            "การส่งเสริมผลิตภัณฑ์ OTOP",
            "การเพิ่มการค้าชายแดน",
            "การลดค่าใช้จ่าย",
            "การลดหนี้สิน",
            "การลดความยากจน",
            "การส่งเสริมการออม",
            "การสร้างอาชีพ",
            "การลดอัตราการหยุดงาน",
            "การพัฒนานวัตกรรม",
            "การพัฒนาระบบขนส่งสาธารณะ",
            "การพัฒนาสินค้าและบริการ",
            "การพัฒนาเทคโนโลยีสารสนเทศ",
            "การพัฒนาระบบโลจิสติกส์",
            "การส่งเสริมธุรกิจอีคอมเมิร์ซ",
            "การพัฒนาบรรจุภัณฑ์สินค้า",
            "การพัฒนาตราสัญลักษณ์สินค้า",
            "การส่งเสริมการสร้างแบรนด์",
            "การส่งเสริมผลิตภัณฑ์แฮนด์เมด"
        ];

        const outcomeSocial = [
            "การส่งเสริมภูมิปัญญาท้องถิ่น",
            "การส่งเสริมวัฒนธรรมท้องถิ่น",
            "การเพิ่มการมีส่วนร่วมในการพัฒนาชุมชน",
            "การเพิ่มการมีส่วนร่วมในกิจกรรมชุมชน",
            "การส่งเสริมความเท่าเทียมทางเพศ",
            "การส่งเสริมความหลากหลายทางชาติพันธุ์",
            "การส่งเสริมการร่วมเป็นอาสาสมัคร",
            "การสืบสานและอนุรักษ์ประเพณี",
            "การพัฒนาความสัมพันธ์ในครอบครัว",
            "การสร้างเครือข่ายความร่วมมือ",
            "การเป็นที่รู้จักมากขึ้น/มีภาพลักษณ์ที่ดีในการบริการวิชาการ",
            "การเกิดสุนทรียภาพ",
            "การลดความขัดแย้ง/การต่อต้าน",
            "การลดการเกิดปัญหา/อุปสรรค",
            "การเพิ่มการเข้าถึงการบริการสุขภาพ",
            "การเพิ่มการเข้าถึงการศึกษา",
            "การพัฒนาคุณภาพชีวิต",
            "การส่งเสริมโภชนาการ",
            "การส่งเสริมการออกกำลังกาย",
            "การลดการเจ็บป่วย",
            "การพัฒนาความรู้และทักษะ",
            "การพัฒนาทักษะแรงงาน",
            "การลดการเกิดปัญหาสุขภาพจิต",
            "การลดการเกิดอุบัติเหตุ",
            "การลดการใช้ยาเสพติด",
            "การลดความรุนแรงในสังคม",
            "การลดการเกิดอาชญากรรม",
            "การเพิ่มการเข้าถึงที่อยู่อาศัย"
        ];

        const outcomeEnvironment = [
            "การลดการปล่อยก๊าซเรือนกระจก",
            "การลดการใช้พลาสติก",
            "การเพิ่มการรีไซเคิล",
            "การเพิ่มการใช้พลังงานทดแทน",
            "การลดการใช้กระดาษ",
            "การลดมลพิษทางอากาศ",
            "การเพิ่มพื้นที่สีเขียว",
            "การลดมลพิษทางน้ำ",
            "การลดการใช้สารเคมี",
            "การลดขยะมูลฝอย",
            "การลดการใช้ปุ๋ยเคมี",
            "การลดการเกิดไฟป่า",
            "การลดมลพิษทางเสียง",
            "การเพิ่มการใช้พลังงานหมุนเวียน"
        ];

        function setDefaultDate() {
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth() + 1;
            const yearBE = today.getFullYear() + 543;
            
            // Set default values for custom date pickers
            setDatePickerValue('recordDate', day, month, yearBE);
            setDatePickerValue('startDate', day, month, yearBE);
            setDatePickerValue('endDate', day, month, yearBE);
        }
        
        // ===== Custom Thai Date Picker Functions =====
        function initializeDatePickers() {
            // แปลง input date เป็น custom date picker
            const dateInputs = ['recordDate', 'startDate', 'endDate'];
            dateInputs.forEach(id => {
                createThaiDatePicker(id);
            });
        }
        
        function createThaiDatePicker(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const parent = input.parentNode;
            const currentValue = input.value;
            
            // สร้าง container ใหม่
            const container = document.createElement('div');
            container.className = 'thai-date-picker';
            container.id = inputId + 'Container';
            container.style.cssText = 'display: flex; gap: 8px; align-items: center;';
            
            // Dropdown วัน
            const daySelect = document.createElement('select');
            daySelect.className = 'form-control';
            daySelect.id = inputId + 'Day';
            daySelect.style.cssText = 'flex: 1; min-width: 70px;';
            daySelect.innerHTML = '<option value="">วัน</option>';
            for (let i = 1; i <= 31; i++) {
                daySelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
            
            // Dropdown เดือน
            const monthSelect = document.createElement('select');
            monthSelect.className = 'form-control';
            monthSelect.id = inputId + 'Month';
            monthSelect.style.cssText = 'flex: 2; min-width: 100px;';
            const thaiMonths = ['', 'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 
                               'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
            monthSelect.innerHTML = '<option value="">เดือน</option>';
            for (let i = 1; i <= 12; i++) {
                monthSelect.innerHTML += `<option value="${i}">${thaiMonths[i]}</option>`;
            }
            
            // Dropdown ปี พ.ศ.
            const yearSelect = document.createElement('select');
            yearSelect.className = 'form-control';
            yearSelect.id = inputId + 'Year';
            yearSelect.style.cssText = 'flex: 1.5; min-width: 90px;';
            const currentYearBE = new Date().getFullYear() + 543;
            yearSelect.innerHTML = '<option value="">ปี พ.ศ.</option>';
            for (let i = currentYearBE + 5; i >= currentYearBE - 20; i--) {
                yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
            
            container.appendChild(daySelect);
            container.appendChild(monthSelect);
            container.appendChild(yearSelect);
            
            // ซ่อน input เดิมและเพิ่ม container ใหม่
            input.type = 'hidden';
            parent.insertBefore(container, input.nextSibling);
            
            // Event listeners เพื่อ sync ค่ากลับไปยัง hidden input
            const syncDate = () => {
                const day = daySelect.value;
                const month = monthSelect.value;
                const yearBE = yearSelect.value;
                if (day && month && yearBE) {
                    const yearCE = parseInt(yearBE) - 543;
                    const dateStr = `${yearCE}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    input.value = dateStr;
                } else {
                    input.value = '';
                }
            };
            
            daySelect.addEventListener('change', syncDate);
            monthSelect.addEventListener('change', syncDate);
            yearSelect.addEventListener('change', syncDate);
            
            // ถ้ามีค่าเดิม ให้แปลงมาแสดง
            if (currentValue) {
                const parts = currentValue.split('-');
                if (parts.length === 3) {
                    const yearBE = parseInt(parts[0]) + 543;
                    const month = parseInt(parts[1]);
                    const day = parseInt(parts[2]);
                    daySelect.value = day;
                    monthSelect.value = month;
                    yearSelect.value = yearBE;
                }
            }
        }
        
        function setDatePickerValue(inputId, day, month, yearBE) {
            const daySelect = document.getElementById(inputId + 'Day');
            const monthSelect = document.getElementById(inputId + 'Month');
            const yearSelect = document.getElementById(inputId + 'Year');
            const hiddenInput = document.getElementById(inputId);
            
            if (daySelect && monthSelect && yearSelect) {
                daySelect.value = day;
                monthSelect.value = month;
                yearSelect.value = yearBE;
                
                // Sync to hidden input
                const yearCE = yearBE - 543;
                hiddenInput.value = `${yearCE}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
        }
        
        function getDatePickerValue(inputId) {
            return document.getElementById(inputId).value;
        }
        
        function loadDateToThaiPicker(inputId, dateValue) {
            if (!dateValue) return;
            
            const parts = dateValue.split('-');
            if (parts.length === 3) {
                const yearCE = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                const yearBE = yearCE + 543;
                
                const daySelect = document.getElementById(inputId + 'Day');
                const monthSelect = document.getElementById(inputId + 'Month');
                const yearSelect = document.getElementById(inputId + 'Year');
                const hiddenInput = document.getElementById(inputId);
                
                if (daySelect && monthSelect && yearSelect) {
                    daySelect.value = day;
                    monthSelect.value = month;
                    yearSelect.value = yearBE;
                }
                
                // ตั้งค่า hidden input ด้วย (ให้แน่ใจว่ามีค่า)
                if (hiddenInput) {
                    hiddenInput.value = dateValue;
                }
            }
        }

        function initializeDropdowns() {
            // Departments - เคลียร์ตัวเลือกเก่าก่อน ยกเว้น default และ other
            const deptSelect = document.getElementById('department');
            const deptOptions = deptSelect.querySelectorAll('option:not([value=""]):not([value="other"])');
            deptOptions.forEach(opt => opt.remove());
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.insertBefore(option, deptSelect.lastElementChild);
            });

            // Strategies - เคลียร์ตัวเลือกเก่าก่อน ยกเว้น default และ other
            const stratSelect = document.getElementById('strategy');
            const stratOptions = stratSelect.querySelectorAll('option:not([value=""]):not([value="other"])');
            stratOptions.forEach(opt => opt.remove());
            
            strategies.forEach(strat => {
                const option = document.createElement('option');
                option.value = strat;
                option.textContent = strat;
                stratSelect.insertBefore(option, stratSelect.lastElementChild);
            });
        }

        function initializeSDGs() {
            const container = document.getElementById('sdgContainer');
            // เคลียร์ SDG เก่าก่อน
            container.innerHTML = '';
            
            sdgList.forEach(sdg => {
                const item = document.createElement('label');
                item.className = `sdg-item sdg-${sdg.id}`;
                item.innerHTML = `
                    <input type="checkbox" name="sdg" value="${sdg.id}" onchange="toggleSDGSelection(this)">
                    <span class="sdg-number">${sdg.id}</span>
                    <span class="sdg-label">${sdg.name}</span>
                `;
                container.appendChild(item);
            });
        }

        function toggleSDGSelection(checkbox) {
            checkbox.closest('.sdg-item').classList.toggle('selected', checkbox.checked);
        }

        // ===== Navigation =====
        function showSection(sectionId, btn) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            btn.classList.add('active');
        }

        function showSubTab(tabId, btn) {
            // Hide all sub-contents
            document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // ===== Other Input Toggle =====
        function toggleOtherInput(selectId, containerId) {
            const select = document.getElementById(selectId);
            const container = document.getElementById(containerId);
            
            if (select.value === 'other') {
                container.classList.add('show');
            } else {
                container.classList.remove('show');
            }
        }

        // ===== Update Outcome Options =====
        function updateOutcomeOptions() {
            const category = document.getElementById('outcomeCategory').value;
            const outcomeSelect = document.getElementById('outcomeType');
            
            // Clear existing options
            outcomeSelect.innerHTML = '<option value="">-- เลือก Outcome --</option>';
            
            let outcomes = [];
            if (category === 'เศรษฐกิจ') {
                outcomes = outcomeEconomic;
            } else if (category === 'สังคม') {
                outcomes = outcomeSocial;
            } else if (category === 'สิ่งแวดล้อม') {
                outcomes = outcomeEnvironment;
            }
            
            outcomes.forEach(o => {
                const option = document.createElement('option');
                option.value = o;
                option.textContent = o;
                outcomeSelect.appendChild(option);
            });
            
            // Add "Other" option
            const otherOption = document.createElement('option');
            otherOption.value = 'other';
            otherOption.textContent = 'อื่นๆ (ระบุ)';
            outcomeSelect.appendChild(otherOption);
        }

        // ===== Stakeholder Modal =====
        function openStakeholderModal(editIndex = -1) {
            document.getElementById('stakeholderModal').classList.add('show');
            document.getElementById('stakeholderEditIndex').value = editIndex;
            
            if (editIndex >= 0) {
                // Edit mode
                document.getElementById('stakeholderModalTitle').textContent = 'แก้ไข Stakeholder';
                const s = stakeholders[editIndex];
                document.getElementById('stakeholderName').value = s.name;
                
                if (['ผู้รับประโยชน์โดยตรง', 'ผู้ดำเนินงานหลัก', 'หน่วยงานสนับสนุนงบประมาณ', 'กลุ่ม/หน่วยงานที่เกี่ยวข้อง'].includes(s.type)) {
                    document.getElementById('stakeholderType').value = s.type;
                } else {
                    document.getElementById('stakeholderType').value = 'other';
                    document.getElementById('stakeholderTypeOtherValue').value = s.type;
                    document.getElementById('stakeholderTypeOther').classList.add('show');
                }
                
                document.getElementById('stakeholderCount').value = s.count;
                
                // Load unit
                if (['คน', 'ชุมชน', 'หน่วยงาน'].includes(s.unit)) {
                    document.getElementById('stakeholderUnit').value = s.unit;
                } else if (s.unit) {
                    document.getElementById('stakeholderUnit').value = 'other';
                    document.getElementById('stakeholderUnitOtherValue').value = s.unit;
                    document.getElementById('stakeholderUnitOther').classList.add('show');
                }
                
                document.getElementById('stakeholderDetail').value = s.detail;
            } else {
                // Add mode
                document.getElementById('stakeholderModalTitle').textContent = 'เพิ่ม Stakeholder';
                clearStakeholderForm();
            }
        }

        function closeStakeholderModal() {
            document.getElementById('stakeholderModal').classList.remove('show');
            clearStakeholderForm();
        }

        function clearStakeholderForm() {
            document.getElementById('stakeholderName').value = '';
            document.getElementById('stakeholderType').value = '';
            document.getElementById('stakeholderTypeOtherValue').value = '';
            document.getElementById('stakeholderTypeOther').classList.remove('show');
            document.getElementById('stakeholderCount').value = '';
            document.getElementById('stakeholderUnit').value = 'คน';
            document.getElementById('stakeholderUnitOtherValue').value = '';
            document.getElementById('stakeholderUnitOther').classList.remove('show');
            document.getElementById('stakeholderDetail').value = '';
        }

        function saveStakeholder() {
            const name = document.getElementById('stakeholderName').value.trim();
            if (!name) {
                showToast('กรุณากรอกชื่อ Stakeholder', 'error');
                return;
            }
            
            let type = document.getElementById('stakeholderType').value;
            if (type === 'other') {
                type = document.getElementById('stakeholderTypeOtherValue').value.trim();
            }
            
            let unit = document.getElementById('stakeholderUnit').value;
            if (unit === 'other') {
                unit = document.getElementById('stakeholderUnitOtherValue').value.trim() || 'คน';
            }
            
            const stakeholder = {
                name: name,
                type: type || '-',
                count: document.getElementById('stakeholderCount').value || 0,
                unit: unit || 'คน',
                detail: document.getElementById('stakeholderDetail').value.trim() || '-'
            };
            
            const editIndex = parseInt(document.getElementById('stakeholderEditIndex').value);
            if (editIndex >= 0) {
                stakeholders[editIndex] = stakeholder;
            } else {
                stakeholders.push(stakeholder);
            }
            
            renderStakeholderTable();
            closeStakeholderModal();
            updateChangeStakeholderDropdown();
            autoSaveData();
            showToast('บันทึก Stakeholder สำเร็จ', 'success');
        }

        function renderStakeholderTable() {
            const tbody = document.getElementById('stakeholderTable');
            
            if (stakeholders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h3>ยังไม่มีข้อมูล Stakeholder</h3>
                                <p>คลิกปุ่ม "เพิ่ม Stakeholder" เพื่อเริ่มต้น</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = stakeholders.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${s.name}</strong></td>
                    <td><span class="badge badge-primary">${s.type}</span></td>
                    <td>${s.count}</td>
                    <td><span class="badge badge-success">${s.unit || 'คน'}</span></td>
                    <td>${s.detail}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-icon btn-edit" onclick="openStakeholderModal(${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteStakeholder(${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function deleteStakeholder(index) {
            if (confirm('ต้องการลบ Stakeholder นี้หรือไม่?')) {
                stakeholders.splice(index, 1);
                renderStakeholderTable();
                updateChangeStakeholderDropdown();
                autoSaveData();
                showToast('ลบ Stakeholder สำเร็จ', 'success');
            }
        }

        // ===== Change Modal =====
        function updateChangeStakeholderDropdown() {
            const select = document.getElementById('changeStakeholder');
            select.innerHTML = '<option value="">-- เลือก Stakeholder --</option>';
            stakeholders.forEach((s, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = s.name;
                select.appendChild(option);
            });
        }

        function openChangeModal(editIndex = -1) {
            updateChangeStakeholderDropdown();
            document.getElementById('changeModal').classList.add('show');
            document.getElementById('changeEditIndex').value = editIndex;
            
            // Reset to first tab
            showSubTab('inputTab', document.querySelector('.sub-tab'));
            
            if (editIndex >= 0) {
                document.getElementById('changeModalTitle').textContent = 'แก้ไข Change';
                const c = changes[editIndex];
                
                // ป้องกัน error กรณีข้อมูลไม่ครบ
                const input = c.input || {};
                const outcome = c.outcome || {};
                const values = outcome.values || {};
                const adjust = c.adjust || {};
                const dropoff = adjust.dropoff || [0, 0, 0, 0, 0];
                
                document.getElementById('changeStakeholder').value = (c.stakeholderIndex !== undefined && c.stakeholderIndex !== null) ? c.stakeholderIndex : '';
                document.getElementById('inputDescription').value = input.description || '';
                document.getElementById('inputValueY0').value = input.valueY0 || '';
                document.getElementById('inputValueY1').value = input.valueY1 || '';
                document.getElementById('inputValueY2').value = input.valueY2 || '';
                document.getElementById('inputValueY3').value = input.valueY3 || '';
                document.getElementById('inputValueY4').value = input.valueY4 || '';
                document.getElementById('inputValueY5').value = input.valueY5 || '';
                document.getElementById('inputAdditionalDetails').value = input.additionalDetails || '';
                
                if (['เศรษฐกิจ', 'สังคม', 'สิ่งแวดล้อม'].includes(outcome.category)) {
                    document.getElementById('outcomeCategory').value = outcome.category;
                    updateOutcomeOptions();
                } else if (outcome.category) {
                    document.getElementById('outcomeCategory').value = 'other';
                    document.getElementById('outcomeCategoryOtherValue').value = outcome.category;
                    document.getElementById('outcomeCategoryOther').classList.add('show');
                }
                
                // Set outcome type
                setTimeout(() => {
                    const outcomeSelect = document.getElementById('outcomeType');
                    let found = false;
                    for (let opt of outcomeSelect.options) {
                        if (opt.value === outcome.type) {
                            outcomeSelect.value = outcome.type;
                            found = true;
                            break;
                        }
                    }
                    if (!found && outcome.type) {
                        outcomeSelect.value = 'other';
                        document.getElementById('outcomeTypeOtherValue').value = outcome.type;
                        document.getElementById('outcomeTypeOther').classList.add('show');
                    }
                }, 100);
                
                document.getElementById('indicator').value = outcome.indicator || '';
                document.getElementById('financialProxy').value = outcome.financialProxy || '';
                document.getElementById('outcomeY0').value = values.Y0 || '';
                document.getElementById('outcomeY1').value = values.Y1 || '';
                document.getElementById('outcomeY2').value = values.Y2 || '';
                document.getElementById('outcomeY3').value = values.Y3 || '';
                document.getElementById('outcomeY4').value = values.Y4 || '';
                document.getElementById('outcomeY5').value = values.Y5 || '';
                
                document.getElementById('deadWeight').value = adjust.deadWeight || '';
                document.getElementById('displacement').value = adjust.displacement || '';
                document.getElementById('attribution').value = adjust.attribution || '';
                document.getElementById('discountRate').value = adjust.discountRate || '3.5';
                document.getElementById('dropoff1').value = dropoff[0] || '';
                document.getElementById('dropoff2').value = dropoff[1] || '';
                document.getElementById('dropoff3').value = dropoff[2] || '';
                document.getElementById('dropoff4').value = dropoff[3] || '';
                document.getElementById('dropoff5').value = dropoff[4] || '';
            } else {
                document.getElementById('changeModalTitle').textContent = 'เพิ่ม Change';
                clearChangeForm();
            }
        }

        function closeChangeModal() {
            document.getElementById('changeModal').classList.remove('show');
            clearChangeForm();
        }

        function clearChangeForm() {
            document.getElementById('changeStakeholder').value = '';
            document.getElementById('inputDescription').value = '';
            document.getElementById('inputValueY0').value = '';
            document.getElementById('inputValueY1').value = '';
            document.getElementById('inputValueY2').value = '';
            document.getElementById('inputValueY3').value = '';
            document.getElementById('inputValueY4').value = '';
            document.getElementById('inputValueY5').value = '';
            document.getElementById('inputAdditionalDetails').value = '';
            document.getElementById('outcomeCategory').value = '';
            document.getElementById('outcomeCategoryOther').classList.remove('show');
            document.getElementById('outcomeCategoryOtherValue').value = '';
            document.getElementById('outcomeType').innerHTML = '<option value="">-- เลือก Outcome --</option><option value="other">อื่นๆ (ระบุ)</option>';
            document.getElementById('outcomeTypeOther').classList.remove('show');
            document.getElementById('outcomeTypeOtherValue').value = '';
            document.getElementById('indicator').value = '';
            document.getElementById('financialProxy').value = '';
            document.getElementById('outcomeY0').value = '';
            document.getElementById('outcomeY1').value = '';
            document.getElementById('outcomeY2').value = '';
            document.getElementById('outcomeY3').value = '';
            document.getElementById('outcomeY4').value = '';
            document.getElementById('outcomeY5').value = '';
            document.getElementById('deadWeight').value = '';
            document.getElementById('displacement').value = '';
            document.getElementById('attribution').value = '';
            document.getElementById('discountRate').value = '3.5';
            document.getElementById('dropoff1').value = '';
            document.getElementById('dropoff2').value = '';
            document.getElementById('dropoff3').value = '';
            document.getElementById('dropoff4').value = '';
            document.getElementById('dropoff5').value = '';
        }

        function saveChange() {
            try {
                console.log('saveChange() called');
                
                const stakeholderIndex = document.getElementById('changeStakeholder').value;
                console.log('stakeholderIndex:', stakeholderIndex);
                
                if (stakeholderIndex === '') {
                    showToast('กรุณาเลือก Stakeholder', 'error');
                    return;
                }
                
                // ตรวจสอบว่ามี stakeholder อยู่จริง
                if (!stakeholders[stakeholderIndex]) {
                    showToast('ไม่พบ Stakeholder ที่เลือก กรุณาเพิ่ม Stakeholder ก่อน', 'error');
                    return;
                }
                
                let outcomeCategory = document.getElementById('outcomeCategory').value;
                if (outcomeCategory === 'other') {
                    outcomeCategory = document.getElementById('outcomeCategoryOtherValue').value.trim();
                }
                
                let outcomeType = document.getElementById('outcomeType').value;
                if (outcomeType === 'other') {
                    outcomeType = document.getElementById('outcomeTypeOtherValue').value.trim();
                }
                
                const change = {
                    stakeholderIndex: parseInt(stakeholderIndex),
                    stakeholderName: stakeholders[stakeholderIndex].name,
                    stakeholderCount: stakeholders[stakeholderIndex].count || 0,
                    stakeholderUnit: stakeholders[stakeholderIndex].unit || 'คน',
                    input: {
                        description: document.getElementById('inputDescription').value.trim(),
                        valueY0: parseFloat(document.getElementById('inputValueY0').value) || 0,
                        valueY1: parseFloat(document.getElementById('inputValueY1').value) || 0,
                        valueY2: parseFloat(document.getElementById('inputValueY2').value) || 0,
                        valueY3: parseFloat(document.getElementById('inputValueY3').value) || 0,
                        valueY4: parseFloat(document.getElementById('inputValueY4').value) || 0,
                        valueY5: parseFloat(document.getElementById('inputValueY5').value) || 0,
                        additionalDetails: document.getElementById('inputAdditionalDetails').value.trim()
                    },
                    outcome: {
                        category: outcomeCategory,
                        type: outcomeType,
                        indicator: document.getElementById('indicator').value.trim(),
                        financialProxy: document.getElementById('financialProxy').value.trim(),
                        values: {
                            Y0: parseFloat(document.getElementById('outcomeY0').value) || 0,
                            Y1: parseFloat(document.getElementById('outcomeY1').value) || 0,
                            Y2: parseFloat(document.getElementById('outcomeY2').value) || 0,
                            Y3: parseFloat(document.getElementById('outcomeY3').value) || 0,
                            Y4: parseFloat(document.getElementById('outcomeY4').value) || 0,
                            Y5: parseFloat(document.getElementById('outcomeY5').value) || 0
                        }
                    },
                    adjust: {
                        deadWeight: parseFloat(document.getElementById('deadWeight').value) || 0,
                        displacement: parseFloat(document.getElementById('displacement').value) || 0,
                        attribution: parseFloat(document.getElementById('attribution').value) || 0,
                        discountRate: parseFloat(document.getElementById('discountRate').value) || 3.5,
                        dropoff: [
                            parseFloat(document.getElementById('dropoff1').value) || 0,
                            parseFloat(document.getElementById('dropoff2').value) || 0,
                            parseFloat(document.getElementById('dropoff3').value) || 0,
                            parseFloat(document.getElementById('dropoff4').value) || 0,
                            parseFloat(document.getElementById('dropoff5').value) || 0
                        ]
                    }
                };
                
                console.log('change object:', change);
                
                const editIndex = parseInt(document.getElementById('changeEditIndex').value);
                if (editIndex >= 0) {
                    changes[editIndex] = change;
                } else {
                    changes.push(change);
                }
                
                console.log('changes array:', changes);
                
                renderChangesTable();
                
                // แสดง Outcome Mapping ทันทีหลังบันทึก Change
                updateOutcomeMapping();
                
                closeChangeModal();
                showToast('บันทึก Change สำเร็จ', 'success');
                
                // บันทึกข้อมูลอัตโนมัติหลังจากแก้ไข Change (skip validation)
                autoSaveData();
                
            } catch (error) {
                console.error('Error in saveChange():', error);
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            }
        }

        function renderChangesTable() {
            const tbody = document.getElementById('changesTable');
            
            if (changes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13">
                            <div class="empty-state">
                                <i class="fas fa-exchange-alt"></i>
                                <h3>ยังไม่มีข้อมูล Change</h3>
                                <p>คลิกปุ่ม "เพิ่ม Change" เพื่อเริ่มต้น</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = changes.map((c, i) => {
                // ป้องกัน error กรณีข้อมูลไม่ครบ
                const input = c.input || {};
                const outcome = c.outcome || {};
                const values = outcome.values || {};
                const adjust = c.adjust || {};
                const dropoff = adjust.dropoff || [0, 0, 0, 0, 0];
                
                // คำนวณ total input (Y0-Y5)
                const totalInput = (input.valueY0 || 0) + (input.valueY1 || 0) + (input.valueY2 || 0) + 
                                   (input.valueY3 || 0) + (input.valueY4 || 0) + (input.valueY5 || 0);
                
                return `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${c.stakeholderName || '-'}</strong></td>
                    <td>${c.stakeholderCount || '-'} ${c.stakeholderUnit || 'คน'}</td>
                    <td>${input.description || '-'}</td>
                    <td style="font-size: 0.8rem;">
                        รวม: ${formatNumber(totalInput)}<br>
                        <small style="color: #718096;">Y0: ${formatNumber(input.valueY0 || 0)}</small>
                    </td>
                    <td><span class="badge badge-${getCategoryBadge(outcome.category)}">${outcome.category || '-'}</span></td>
                    <td>${outcome.type || '-'}</td>
                    <td>${outcome.indicator || '-'}</td>
                    <td>${outcome.financialProxy || '-'}</td>
                    <td style="font-size: 0.8rem;">
                        Y0: ${formatNumber(values.Y0 || 0)}<br>
                        Y1: ${formatNumber(values.Y1 || 0)}<br>
                        Y2: ${formatNumber(values.Y2 || 0)}<br>
                        Y3: ${formatNumber(values.Y3 || 0)}<br>
                        Y4: ${formatNumber(values.Y4 || 0)}<br>
                        Y5: ${formatNumber(values.Y5 || 0)}
                    </td>
                    <td style="font-size: 0.8rem;">
                        DW: ${adjust.deadWeight || 0}%<br>
                        DP: ${adjust.displacement || 0}%<br>
                        AT: ${adjust.attribution || 0}%<br>
                        DR: ${adjust.discountRate || 3.5}%
                    </td>
                    <td style="font-size: 0.8rem;">
                        Y1: ${dropoff[0] || 0}%<br>
                        Y2: ${dropoff[1] || 0}%<br>
                        Y3: ${dropoff[2] || 0}%<br>
                        Y4: ${dropoff[3] || 0}%<br>
                        Y5: ${dropoff[4] || 0}%
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-icon btn-edit" onclick="openChangeModal(${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteChange(${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function getCategoryBadge(category) {
            if (category === 'เศรษฐกิจ') return 'warning';
            if (category === 'สังคม') return 'primary';
            if (category === 'สิ่งแวดล้อม') return 'success';
            return 'primary';
        }

        function deleteChange(index) {
            if (confirm('ต้องการลบ Change นี้หรือไม่?')) {
                changes.splice(index, 1);
                renderChangesTable();
                updateOutcomeMapping();
                autoSaveData();
                showToast('ลบ Change สำเร็จ', 'success');
            }
        }

        // ===== SROI Calculation =====
        function calculateSROI() {
            const budget = parseFloat(document.getElementById('budget').value) || 0;
            
            console.log('=== calculateSROI() ===');
            console.log('budget:', budget);
            console.log('changes:', JSON.stringify(changes, null, 2));
            
            if (budget <= 0) {
                showToast('กรุณากรอกงบประมาณโครงการ', 'error');
                return;
            }
            
            if (changes.length === 0) {
                showToast('กรุณาเพิ่มข้อมูล Change อย่างน้อย 1 รายการ', 'error');
                return;
            }
            
            // Calculate Total Investment (Input Y0 + Budget)
            let totalInputValue = 0;
            changes.forEach(c => {
                const input = c.input || {};
                totalInputValue += (input.valueY0 || 0);
            });
            const totalInvestment = budget;
            
            // Calculate Present Value for each change
            let totalPresentValue = 0;
            
            changes.forEach((c, idx) => {
                // ป้องกัน error กรณีข้อมูลไม่ครบ
                const adjust = c.adjust || {};
                const outcome = c.outcome || {};
                const values = outcome.values || {};
                const dropoffArr = adjust.dropoff || [0, 0, 0, 0, 0];
                
                console.log(`Change ${idx} - outcome:`, outcome);
                console.log(`Change ${idx} - values:`, values);
                
                const dw = (adjust.deadWeight || 0) / 100;
                const dp = (adjust.displacement || 0) / 100;
                const at = (adjust.attribution || 0) / 100;
                const dr = (adjust.discountRate || 3.5) / 100;
                const dropoffs = dropoffArr.map(d => (d || 0) / 100);
                
                const years = ['Y0', 'Y1', 'Y2', 'Y3', 'Y4', 'Y5'];
                
                years.forEach((year, yearIndex) => {
                    const value = values[year] || 0;
                    console.log(`  ${year}: ${value}`);
                    
                    // Adjusted Value = Value × (1 - DW) × (1 - DP) × (1 - AT)
                    let adjustedValue = value * (1 - dw) * (1 - dp) * (1 - at);
                    
                    // Apply drop-off for years > 0
                    if (yearIndex > 0) {
                        let cumulativeDropoff = 1;
                        for (let j = 0; j < yearIndex && j < dropoffs.length; j++) {
                            cumulativeDropoff *= (1 - dropoffs[j]);
                        }
                        adjustedValue *= cumulativeDropoff;
                    }
                    
                    // Present Value = Adjusted Value / (1 + DR)^n
                    const presentValue = adjustedValue / Math.pow(1 + dr, yearIndex);
                    totalPresentValue += presentValue;
                });
            });
            
            console.log('totalPresentValue:', totalPresentValue);
            console.log('totalInvestment:', totalInvestment);
            
            // SROI Ratio
            const sroiRatio = totalInvestment > 0 ? totalPresentValue / totalInvestment : 0;
            const netBenefit = totalPresentValue - totalInvestment;
            
            console.log('sroiRatio:', sroiRatio);
            
            // Store result
            sroiResult = {
                sroiRatio: sroiRatio,
                totalPresentValue: totalPresentValue,
                totalInvestment: totalInvestment,
                netBenefit: netBenefit
            };
            
            // Display results
            document.getElementById('sroiRatio').textContent = sroiRatio.toFixed(2);
            document.getElementById('totalPV').textContent = formatNumber(totalPresentValue);
            document.getElementById('totalInvestment').textContent = formatNumber(totalInvestment);
            document.getElementById('netBenefit').textContent = formatNumber(netBenefit);
            
            // Update Outcome Mapping table
            updateOutcomeMapping();
            
            // Update summary section
            updateSummary();
            
            showToast('คำนวณ SROI สำเร็จ', 'success');
        }
        
        // Function to update Outcome Mapping table
        function updateOutcomeMapping() {
            const tbody = document.getElementById('outcomeMappingTable');
            const expectedResults = document.getElementById('expectedResults').value || '-';
            
            if (changes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state" style="padding: 1rem;">
                                <i class="fas fa-info-circle"></i>
                                <p>ไม่มีข้อมูล Change</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Group by stakeholder
            const stakeholderMap = new Map();
            changes.forEach(c => {
                const key = c.stakeholderIndex;
                if (!stakeholderMap.has(key)) {
                    stakeholderMap.set(key, {
                        name: c.stakeholderName,
                        inputs: [],
                        outcomes: [],
                        activities: []
                    });
                }
                const data = stakeholderMap.get(key);
                if (c.input && c.input.description) {
                    data.inputs.push(c.input.description);
                }
                if (c.outcome && c.outcome.type) {
                    data.outcomes.push(c.outcome.type);
                }
                // Get activity from stakeholder detail
                const stakeholder = stakeholders[c.stakeholderIndex];
                if (stakeholder && stakeholder.detail && stakeholder.detail !== '-' && !data.activities.includes(stakeholder.detail)) {
                    data.activities.push(stakeholder.detail);
                }
            });
            
            let rows = '';
            stakeholderMap.forEach((data, key) => {
                rows += `
                    <tr>
                        <td>${data.inputs.join('<br>') || '-'}</td>
                        <td>${data.activities.join('<br>') || '-'}</td>
                        <td>${expectedResults}</td>
                        <td><strong>${data.name}</strong></td>
                        <td>${data.outcomes.join('<br>') || '-'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows;
        }

        function updateSummary() {
            if (!sroiResult) return;
            
            const projectName = document.getElementById('projectName').value || '-';
            const department = getSelectedValue('department', 'departmentOtherValue');
            const recordDate = document.getElementById('recordDate').value;
            const formattedDate = recordDate ? formatThaiDate(recordDate) : '-';
            
            const selectedSDGs = [];
            document.querySelectorAll('input[name="sdg"]:checked').forEach(cb => {
                selectedSDGs.push(cb.value);
            });
            
            document.getElementById('summaryContent').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="card" style="margin-bottom: 0;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">
                            <i class="fas fa-file-alt"></i> ข้อมูลโครงการ
                        </h4>
                        <p><strong>ชื่อโครงการ:</strong> ${projectName}</p>
                        <p><strong>หน่วยงาน:</strong> ${department || '-'}</p>
                        <p><strong>วันที่ประเมิน:</strong> ${formattedDate}</p>
                        <p><strong>SDGs ที่เกี่ยวข้อง:</strong> ${selectedSDGs.length > 0 ? selectedSDGs.join(', ') : '-'}</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 0;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">
                            <i class="fas fa-chart-pie"></i> ผลการประเมิน SROI
                        </h4>
                        <p><strong>SROI Ratio:</strong> <span style="font-size: 1.5rem; color: var(--accent); font-weight: 700;">${sroiResult.sroiRatio.toFixed(2)}</span></p>
                        <p><strong>Total Present Value:</strong> ${formatNumber(sroiResult.totalPresentValue)} บาท</p>
                        <p><strong>Total Investment:</strong> ${formatNumber(sroiResult.totalInvestment)} บาท</p>
                        <p><strong>Net Benefit:</strong> ${formatNumber(sroiResult.netBenefit)} บาท</p>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i> การตีความผล SROI
                    </h4>
                    <p>ค่า SROI = <strong>${sroiResult.sroiRatio.toFixed(2)}</strong> หมายความว่า ทุกๆ 1 บาท ที่ลงทุนในโครงการนี้ สร้างมูลค่าทางสังคมได้ <strong>${sroiResult.sroiRatio.toFixed(2)} บาท</strong></p>
                    ${sroiResult.sroiRatio >= 1 ? 
                        '<p style="color: var(--accent);"><i class="fas fa-check-circle"></i> โครงการนี้สร้างมูลค่าทางสังคมคุ้มค่ากับการลงทุน</p>' : 
                        '<p style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> โครงการนี้อาจต้องพิจารณาปรับปรุงเพื่อเพิ่มประสิทธิภาพ</p><p style="color: #718096; font-size: 0.9rem; margin-top: 0.5rem; padding-left: 1.5rem;"><strong>หมายเหตุ:</strong> ทั้งนี้ ขึ้นอยู่กับการพิจารณาของหน่วยงาน ในกรณีที่การประเมินผลออกมาแล้วไม่คุ้มค่าคุ้มทุน</p>'
                    }
                </div>
            `;
        }

        // ===== Certificate Download =====
        function downloadCertificate() {
            // Demo mode - ไม่อนุญาตให้ดาวน์โหลด
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                showToast('🔒 ต้องเข้าใช้งานเว็บไซต์จริงที่ sroi.kku.ac.th เพื่อดาวน์โหลดใบรับรอง', 'info');
                return;
            }
            
            if (!sroiResult) {
                showToast('กรุณาคำนวณ SROI ก่อน', 'error');
                return;
            }
            
            const projectName = document.getElementById('projectName').value || 'ไม่ระบุชื่อโครงการ';
            const department = getSelectedValue('department', 'departmentOtherValue') || 'ไม่ระบุหน่วยงาน';
            const projectType = getSelectedValue('projectType', 'projectTypeOtherValue') || 'ไม่ระบุรูปแบบ';
            const evaluationType = getSelectedValue('evaluationType', 'evaluationTypeOtherValue') || '';
            const recordDate = document.getElementById('recordDate').value;
            const formattedDate = recordDate ? formatThaiDate(recordDate) : formatThaiDate(new Date().toISOString().split('T')[0]);
            
            const canvas = document.getElementById('certificateCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size (A4 aspect ratio)
            canvas.width = 1200;
            canvas.height = 1697;
            
            // Load certificate background image
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                // Draw background image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Add text overlay
                ctx.textAlign = 'center';
                
                // รูปแบบการประเมิน (อยู่กึ่งกลางระหว่าง "รับรองการประเมินด้วยตนเอง" กับ "การประเมินผลตอบแทนทางสังคม")
                if (evaluationType) {
                    ctx.font = 'bold 28px Prompt, sans-serif';
                    ctx.fillStyle = '#1a365d';
                    ctx.fillText(`${evaluationType}`, canvas.width / 2, 530);
                }
                
                // Project Type (รูปแบบโครงการ)
                ctx.font = 'bold 28px Prompt, sans-serif';
                ctx.fillStyle = '#1a365d';
                ctx.fillText(`การประเมินผลตอบแทนทางสังคม (SROI)`, canvas.width / 2, 570);
                ctx.fillText(`${projectType}`, canvas.width / 2, 610);
                
                // Project Name - ตัวเล็กลงและไม่มีหัวข้อ
                ctx.font = 'bold 30px Kanit, sans-serif';
                ctx.fillStyle = '#1a365d';
                wrapText(ctx, `${projectName}`, canvas.width / 2, 670, 1000, 40);
                
                // Department - ตัวหนา
                ctx.font = 'bold 28px Prompt, sans-serif';
                ctx.fillStyle = '#4a5568';
                ctx.fillText(`${department}`, canvas.width / 2, 780);
                
                // University - ตัวหนา
                ctx.fillText(`มหาวิทยาลัยขอนแก่น`, canvas.width / 2, 830);
                
                // SROI Result
                ctx.font = 'bold 48px Kanit, sans-serif';
                ctx.fillStyle = '#c9a227';
                ctx.fillText(`SROI = ${sroiResult.sroiRatio.toFixed(2)}`, canvas.width / 2, 900);
                
                // Date (bottom right) - ขยับลงมา 2 บรรทัด
                ctx.textAlign = 'right';
                ctx.font = '22px Prompt, sans-serif';
                ctx.fillStyle = '#4a5568';
                ctx.fillText(`วันที่ประเมิน: ${formattedDate}`, canvas.width - 80, canvas.height - 50);
                
                // Download
                const link = document.createElement('a');
                link.download = `SROI_Certificate_${projectName.replace(/\s+/g, '_')}.jpeg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
                
                showToast('ดาวน์โหลด Certificate สำเร็จ', 'success');
            };
            
            img.onerror = function() {
                // If image fails to load, create certificate without background
                createCertificateWithoutBackground(ctx, canvas, projectName, department, projectType, formattedDate, evaluationType);
            };
            
            // Try to load the uploaded certificate image
            img.src = 'images/Certificate_SROI.png';
        }

        // ===== Certificate Download (English Version) =====
        function downloadCertificateEN() {
            // Demo mode - ไม่อนุญาตให้ดาวน์โหลด
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                showToast('🔒 ต้องเข้าใช้งานเว็บไซต์จริงที่ sroi.kku.ac.th เพื่อดาวน์โหลดใบรับรอง', 'info');
                return;
            }
            
            if (!sroiResult) {
                showToast('Please calculate SROI first', 'error');
                return;
            }
            
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const department = getSelectedValue('department', 'departmentOtherValue') || 'Unspecified Department';
            const projectType = getSelectedValue('projectType', 'projectTypeOtherValue') || 'Unspecified Type';
            const evaluationType = getSelectedValue('evaluationType', 'evaluationTypeOtherValue') || '';
            const recordDate = document.getElementById('recordDate').value;
            const formattedDate = recordDate ? formatEnglishDate(recordDate) : formatEnglishDate(new Date().toISOString().split('T')[0]);
            
            const canvas = document.getElementById('certificateCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size (A4 aspect ratio)
            canvas.width = 1200;
            canvas.height = 1697;
            
            // Load certificate background image
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                // Draw background image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Add text overlay
                ctx.textAlign = 'center';
                
                // Evaluation Type
                if (evaluationType) {
                    ctx.font = 'bold 28px Prompt, sans-serif';
                    ctx.fillStyle = '#1a365d';
                    ctx.fillText(`${translateEvaluationType(evaluationType)}`, canvas.width / 2, 530);
                }
                
                // Project Type
                ctx.font = 'bold 28px Prompt, sans-serif';
                ctx.fillStyle = '#1a365d';
                ctx.fillText(`Social Return on Investment (SROI) Assessment`, canvas.width / 2, 570);
                ctx.fillText(`${translateProjectType(projectType)}`, canvas.width / 2, 610);
                
                // Project Name
                ctx.font = 'bold 30px Kanit, sans-serif';
                ctx.fillStyle = '#1a365d';
                wrapText(ctx, `${projectName}`, canvas.width / 2, 670, 1000, 40);
                
                // Department
                ctx.font = 'bold 28px Prompt, sans-serif';
                ctx.fillStyle = '#4a5568';
                ctx.fillText(`${department}`, canvas.width / 2, 780);
                
                // University
                ctx.fillText(`Khon Kaen University`, canvas.width / 2, 830);
                
                // SROI Result
                ctx.font = 'bold 48px Kanit, sans-serif';
                ctx.fillStyle = '#c9a227';
                ctx.fillText(`SROI = ${sroiResult.sroiRatio.toFixed(2)}`, canvas.width / 2, 900);
                
                // Date (bottom right)
                ctx.textAlign = 'right';
                ctx.font = '22px Prompt, sans-serif';
                ctx.fillStyle = '#4a5568';
                ctx.fillText(`Assessment Date: ${formattedDate}`, canvas.width - 80, canvas.height - 50);
                
                // Download
                const link = document.createElement('a');
                link.download = `SROI_Certificate_EN_${projectName.replace(/\s+/g, '_')}.jpeg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
                
                showToast('Certificate downloaded successfully', 'success');
            };
            
            img.onerror = function() {
                showToast('Failed to load certificate image', 'error');
            };
            
            // Load English certificate template
            img.src = 'images/Certificate_SROI_EN.png';
        }

        // Format date in English
        function formatEnglishDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Translate evaluation type to English
        function translateEvaluationType(type) {
            const translations = {
                'การประเมินก่อนดำเนินโครงการ (Ex-ante)': 'Ex-ante Evaluation',
                'การประเมินระหว่างดำเนินโครงการ (During)': 'During Project Evaluation',
                'การประเมินหลังสิ้นสุดโครงการ (Ex-post)': 'Ex-post Evaluation'
            };
            return translations[type] || type;
        }

        // Translate project type to English
        function translateProjectType(type) {
            const translations = {
                'โครงการบริการวิชาการ': 'Academic Service Project',
                'โครงการวิจัย': 'Research Project',
                'โครงการทำนุบำรุงศิลปวัฒนธรรม': 'Art and Culture Preservation Project',
                'โครงการพัฒนานักศึกษา': 'Student Development Project',
                'โครงการอื่นๆ': 'Other Project'
            };
            return translations[type] || type;
        }

        function createCertificateWithoutBackground(ctx, canvas, projectName, department, projectType, formattedDate, evaluationType) {
            // Create a nice gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#f8f9fa');
            gradient.addColorStop(1, '#e9ecef');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Gold border
            ctx.strokeStyle = '#c9a227';
            ctx.lineWidth = 20;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
            
            // Inner border
            ctx.strokeStyle = '#a73b24';
            ctx.lineWidth = 3;
            ctx.strokeRect(70, 70, canvas.width - 140, canvas.height - 140);
            
            // Corner decorations
            drawCornerDecoration(ctx, 40, 40, 100, 1, 1);
            drawCornerDecoration(ctx, canvas.width - 40, 40, 100, -1, 1);
            drawCornerDecoration(ctx, 40, canvas.height - 40, 100, 1, -1);
            drawCornerDecoration(ctx, canvas.width - 40, canvas.height - 40, 100, -1, -1);
            
            ctx.textAlign = 'center';
            
            // Header
            ctx.font = 'bold 60px Kanit, sans-serif';
            ctx.fillStyle = '#a73b24';
            ctx.fillText('SROI Platform', canvas.width / 2, 200);
            
            ctx.font = 'bold 80px Kanit, sans-serif';
            ctx.fillStyle = '#c9a227';
            ctx.fillText('CERTIFICATE', canvas.width / 2, 320);
            
            ctx.font = '36px Prompt, sans-serif';
            ctx.fillStyle = '#4a5568';
            ctx.fillText('รับรองการประเมินด้วยตัวเอง', canvas.width / 2, 380);
            
            // Divider line
            ctx.strokeStyle = '#c9a227';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(200, 420);
            ctx.lineTo(canvas.width - 200, 420);
            ctx.stroke();
            
            // รูปแบบการประเมิน
            if (evaluationType) {
                ctx.font = 'bold 32px Prompt, sans-serif';
                ctx.fillStyle = '#1a365d';
                ctx.fillText(`${evaluationType}`, canvas.width / 2, 500);
            }
            
            // Project Info
            ctx.font = 'bold 32px Prompt, sans-serif';
            ctx.fillStyle = '#1a365d';
            ctx.fillText(`การประเมินผลตอบแทนทางสังคม (SROI)`, canvas.width / 2, 560);
            ctx.fillText(`${projectType}`, canvas.width / 2, 610);
            
            // Project Name
            ctx.font = 'bold 36px Kanit, sans-serif';
            ctx.fillStyle = '#1a365d';
            wrapText(ctx, `${projectName}`, canvas.width / 2, 690, 1000, 45);
            
            // Department
            ctx.font = 'bold 32px Prompt, sans-serif';
            ctx.fillStyle = '#4a5568';
            ctx.fillText(`${department}`, canvas.width / 2, 820);
            ctx.fillText(`มหาวิทยาลัยขอนแก่น`, canvas.width / 2, 870);
            
            // SROI Result Box
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(400, 900, 400, 120);
            ctx.strokeStyle = '#c9a227';
            ctx.lineWidth = 3;
            ctx.strokeRect(400, 900, 400, 120);
            
            ctx.font = 'bold 60px Kanit, sans-serif';
            ctx.fillStyle = '#c9a227';
            ctx.fillText(`SROI = ${sroiResult.sroiRatio.toFixed(2)}`, canvas.width / 2, 980);
            
            // Description
            ctx.font = '24px Prompt, sans-serif';
            ctx.fillStyle = '#4a5568';
            const desc1 = 'รายงานผลการประเมิน SROI ของแผนงานดังกล่าว ประเมินผ่าน SROI Platform';
            const desc2 = 'ภายใต้มหาวิทยาลัยขอนแก่น ครอบคลุมตามกระบวนการปฏิบัติที่เหมาะสม ตามกรอบแนวทาง';
            const desc3 = 'การประเมินผลสัมฤทธิ์สังคมตามหลักการ Social Value Principle ตามหลักมาตรฐานสากล';
            ctx.fillText(desc1, canvas.width / 2, 1100);
            ctx.fillText(desc2, canvas.width / 2, 1140);
            ctx.fillText(desc3, canvas.width / 2, 1180);
            
            // Seal/Badge
            drawSeal(ctx, canvas.width / 2, 1380, 80);
            
            // Date (bottom right) - ขยับลงมา 2 บรรทัด
            ctx.textAlign = 'right';
            ctx.font = '24px Prompt, sans-serif';
            ctx.fillStyle = '#4a5568';
            ctx.fillText(`วันที่ประเมิน: ${formattedDate}`, canvas.width - 100, canvas.height - 70);
            
            // Download
            const link = document.createElement('a');
            link.download = `SROI_Certificate_${projectName.replace(/\s+/g, '_')}.jpeg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
            
            showToast('ดาวน์โหลด Certificate สำเร็จ', 'success');
        }

        function drawCornerDecoration(ctx, x, y, size, dirX, dirY) {
            ctx.strokeStyle = '#c9a227';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(x, y + size * dirY);
            ctx.lineTo(x, y);
            ctx.lineTo(x + size * dirX, y);
            ctx.stroke();
        }

        function drawSeal(ctx, x, y, radius) {
            // Outer circle
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            const gradient = ctx.createRadialGradient(x - 20, y - 20, 0, x, y, radius);
            gradient.addColorStop(0, '#f0d77b');
            gradient.addColorStop(0.5, '#c9a227');
            gradient.addColorStop(1, '#8b6914');
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Inner circle
            ctx.beginPath();
            ctx.arc(x, y, radius - 15, 0, Math.PI * 2);
            ctx.fillStyle = '#c9a227';
            ctx.fill();
            
            // Star points
            const points = 16;
            ctx.beginPath();
            for (let i = 0; i < points * 2; i++) {
                const r = i % 2 === 0 ? radius : radius - 10;
                const angle = (Math.PI * 2 / (points * 2)) * i - Math.PI / 2;
                const px = x + r * Math.cos(angle);
                const py = y + r * Math.sin(angle);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.fillStyle = '#c9a227';
            ctx.fill();
            
            // Text in seal
            ctx.font = 'bold 20px Kanit, sans-serif';
            ctx.fillStyle = '#a73b24';
            ctx.textAlign = 'center';
            ctx.fillText('KKU', x, y + 8);
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let testLine, metrics, testWidth;
            
            for (let n = 0; n < words.length; n++) {
                testLine = line + words[n] + ' ';
                metrics = ctx.measureText(testLine);
                testWidth = metrics.width;
                
                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, y);
        }

        // ===== Export to Excel =====
        function exportToExcel() {
            // Demo mode - ไม่อนุญาตให้ส่งออก
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                showToast('🔒 ต้องเข้าใช้งานเว็บไซต์จริงที่ sroi.kku.ac.th เพื่อส่งออกข้อมูล Excel', 'info');
                return;
            }
            
            if (!sroiResult) {
                showToast('กรุณาคำนวณ SROI ก่อน', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Project Info
            const projectData = [
                ['ข้อมูลโครงการ SROI - มหาวิทยาลัยขอนแก่น'],
                [''],
                ['ชื่อโครงการ', document.getElementById('projectName').value],
                ['วันที่บันทึก', document.getElementById('recordDate').value],
                ['ชื่อผู้บันทึก', document.getElementById('recorderName').value],
                ['งบประมาณ (บาท)', document.getElementById('budget').value],
                ['รูปแบบโครงการ', getSelectedValue('projectType', 'projectTypeOtherValue')],
                ['หน่วยงานที่รับผิดชอบ', getSelectedValue('department', 'departmentOtherValue')],
                ['ยุทธศาสตร์', getSelectedValue('strategy', 'strategyOtherValue')],
                ['รูปแบบการประเมิน', getSelectedValue('evaluationType', 'evaluationTypeOtherValue')],
                ['วัตถุประสงค์', document.getElementById('objectives').value],
                ['ผลที่คาดว่าจะได้รับ', document.getElementById('expectedResults').value],
                ['วันที่เริ่มต้น', document.getElementById('startDate').value],
                ['วันที่สิ้นสุด', document.getElementById('endDate').value],
                ['SDGs ที่เกี่ยวข้อง', getSelectedSDGs().join(', ')]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(projectData);
            XLSX.utils.book_append_sheet(wb, ws1, 'ข้อมูลโครงการ');
            
            // Sheet 2: Stakeholders
            const stakeholderData = [
                ['Stakeholders (ผู้มีส่วนได้ส่วนเสีย)'],
                [''],
                ['ลำดับ', 'ชื่อ', 'ประเภท', 'จำนวน', 'รายละเอียด'],
                ...stakeholders.map((s, i) => [i + 1, s.name, s.type, s.count, s.detail])
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(stakeholderData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Stakeholders');
            
            // Sheet 3: Changes
            const changesData = [
                ['Changes (การเปลี่ยนแปลง)'],
                [''],
                ['ลำดับ', 'Stakeholder', 'Input', 'มูลค่า Input (Y0)', 'ประเภท Outcome', 'Outcome', 'ตัวชี้วัด', 'Financial Proxy', 'Y0', 'Y1', 'Y2', 'Y3', 'Y4', 'Y5', 'Dead Weight (%)', 'Displacement (%)', 'Attribution (%)', 'Discount Rate (%)'],
                ...changes.map((c, i) => [
                    i + 1,
                    c.stakeholderName,
                    c.input.description,
                    c.input.valueY0,
                    c.outcome.category,
                    c.outcome.type,
                    c.outcome.indicator,
                    c.outcome.financialProxy,
                    c.outcome.values.Y0,
                    c.outcome.values.Y1,
                    c.outcome.values.Y2,
                    c.outcome.values.Y3,
                    c.outcome.values.Y4,
                    c.outcome.values.Y5,
                    c.adjust.deadWeight,
                    c.adjust.displacement,
                    c.adjust.attribution,
                    c.adjust.discountRate
                ])
            ];
            const ws3 = XLSX.utils.aoa_to_sheet(changesData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Changes');
            
            // Sheet 4: SROI Results
            const resultsData = [
                ['ผลการคำนวณ SROI'],
                [''],
                ['SROI Ratio', sroiResult.sroiRatio.toFixed(4)],
                ['Total Present Value (บาท)', sroiResult.totalPresentValue.toFixed(2)],
                ['Total Investment (บาท)', sroiResult.totalInvestment.toFixed(2)],
                ['Net Benefit (บาท)', sroiResult.netBenefit.toFixed(2)],
                [''],
                ['การตีความผล'],
                [`ทุกๆ 1 บาท ที่ลงทุนในโครงการนี้ สร้างมูลค่าทางสังคมได้ ${sroiResult.sroiRatio.toFixed(2)} บาท`]
            ];
            const ws4 = XLSX.utils.aoa_to_sheet(resultsData);
            XLSX.utils.book_append_sheet(wb, ws4, 'ผลการคำนวณ');
            
            // Download
            const projectName = document.getElementById('projectName').value || 'SROI';
            XLSX.writeFile(wb, `SROI_Report_${projectName.replace(/\s+/g, '_')}.xlsx`);
            
            showToast('ส่งออกข้อมูล Excel สำเร็จ', 'success');
        }

        // ===== Print Report =====
        function printReport() {
            // Demo mode - ไม่อนุญาตให้พิมพ์
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                showToast('🔒 ต้องเข้าใช้งานเว็บไซต์จริงที่ sroi.kku.ac.th เพื่อพิมพ์รายงาน', 'info');
                return;
            }
            
            window.print();
        }

        // ===== Utility Functions =====
        function getSelectedValue(selectId, otherInputId) {
            const select = document.getElementById(selectId);
            if (select.value === 'other') {
                return document.getElementById(otherInputId).value;
            }
            return select.value;
        }

        function getSelectedSDGs() {
            const selected = [];
            document.querySelectorAll('input[name="sdg"]:checked').forEach(cb => {
                selected.push(cb.value);
            });
            return selected;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function formatThaiDate(dateStr) {
            const date = new Date(dateStr);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const thaiDate = date.toLocaleDateString('th-TH', options);
            return thaiDate;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = 'toast show ' + type;
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function resetForm() {
            if (confirm('ต้องการล้างข้อมูลทั้งหมดหรือไม่?')) {
                document.getElementById('projectName').value = '';
                document.getElementById('recorderName').value = '';
                document.getElementById('budget').value = '';
                document.getElementById('projectType').value = '';
                document.getElementById('department').value = '';
                document.getElementById('strategy').value = '';
                document.getElementById('evaluationType').value = '';
                document.getElementById('objectives').value = '';
                document.getElementById('expectedResults').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                
                // Clear other input fields
                document.querySelectorAll('.other-input-container').forEach(c => c.classList.remove('show'));
                document.querySelectorAll('.other-input-container input').forEach(i => i.value = '');
                
                // Clear SDGs
                document.querySelectorAll('input[name="sdg"]').forEach(cb => {
                    cb.checked = false;
                    cb.closest('.sdg-item').classList.remove('selected');
                });
                
                // Clear data
                stakeholders = [];
                changes = [];
                sroiResult = null;
                
                // Re-render tables
                renderStakeholderTable();
                renderChangesTable();
                
                // Clear results
                document.getElementById('sroiRatio').textContent = '-';
                document.getElementById('totalPV').textContent = '-';
                document.getElementById('totalInvestment').textContent = '-';
                document.getElementById('netBenefit').textContent = '-';
                document.getElementById('summaryContent').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>กรุณาคำนวณ SROI ก่อน</h3>
                        <p>ไปที่แท็บ "ผลการคำนวณ" และคลิกปุ่ม "คำนวณ SROI"</p>
                    </div>
                `;
                
                setDefaultDate();
                showToast('ล้างข้อมูลสำเร็จ', 'success');
            }
        }

        // =====================================================
        // API Configuration - เชื่อมต่อ Backend Server
        // =====================================================
        const API_BASE_URL = window.location.origin + '/api';
        
        // ดึง projectId จาก URL parameter (ถ้ามี)
        // currentProjectId ถูกกำหนดไว้แล้วในส่วน <head>
        let currentUserId = 1; // ใช้สำหรับ backward compatibility

        // Auto-save function (ไม่ต้อง validate phoneNumber)
        async function autoSaveData() {
            // Demo mode - ไม่บันทึกลง server
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                console.log('Demo mode - ไม่บันทึกข้อมูล');
                return;
            }
            
            const data = {
                project: {
                    name: document.getElementById('projectName').value,
                    recordDate: document.getElementById('recordDate').value,
                    recorderName: document.getElementById('recorderName').value,
                    budget: document.getElementById('budget').value,
                    projectType: getSelectedValue('projectType', 'projectTypeOtherValue'),
                    department: getSelectedValue('department', 'departmentOtherValue'),
                    strategy: getSelectedValue('strategy', 'strategyOtherValue'),
                    evaluationType: getSelectedValue('evaluationType', 'evaluationTypeOtherValue'),
                    objectives: document.getElementById('objectives').value,
                    expectedResults: document.getElementById('expectedResults').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    sdgs: getSelectedSDGs(),
                    phoneNumber: document.getElementById('phoneNumber').value || ''
                },
                stakeholders: stakeholders,
                changes: changes,
                sroiResult: sroiResult,
                userId: currentUserId,
                projectId: currentProjectId
            };
            
            try {
                const response = await fetch(API_BASE_URL + '/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // อัพเดท projectId ถ้าเป็นโครงการใหม่
                    if (!currentProjectId && result.projectId) {
                        currentProjectId = result.projectId;
                    }
                    localStorage.setItem('sroiData', JSON.stringify(data));
                    console.log('Auto-save สำเร็จ');
                }
            } catch (error) {
                console.log('Auto-save ล้มเหลว:', error.message);
                localStorage.setItem('sroiData', JSON.stringify(data));
            }
        }

        async function saveData() {
            // Demo mode - ไม่บันทึกลง server
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                showToast('🎮 Demo Mode - ข้อมูลจะไม่ถูกบันทึก แต่คุณสามารถทดลองใช้งานได้', 'info');
                return;
            }
            
            // Validate phone number
            const phoneNumber = document.getElementById('phoneNumber').value;
            if (!phoneNumber || phoneNumber.length < 9) {
                showToast('กรุณากรอกเบอร์โทรติดต่อ (9-10 หลัก)', 'error');
                document.getElementById('phoneNumber').focus();
                return;
            }
            
            const data = {
                project: {
                    name: document.getElementById('projectName').value,
                    recordDate: document.getElementById('recordDate').value,
                    recorderName: document.getElementById('recorderName').value,
                    budget: document.getElementById('budget').value,
                    projectType: getSelectedValue('projectType', 'projectTypeOtherValue'),
                    department: getSelectedValue('department', 'departmentOtherValue'),
                    strategy: getSelectedValue('strategy', 'strategyOtherValue'),
                    evaluationType: getSelectedValue('evaluationType', 'evaluationTypeOtherValue'),
                    objectives: document.getElementById('objectives').value,
                    expectedResults: document.getElementById('expectedResults').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    sdgs: getSelectedSDGs(),
                    phoneNumber: phoneNumber
                },
                stakeholders: stakeholders,
                changes: changes,
                sroiResult: sroiResult,
                userId: currentUserId,
                projectId: currentProjectId  // เพิ่ม projectId
            };
            
            // Debug: แสดงข้อมูล changes ที่จะบันทึก
            console.log('=== Saving Data ===');
            console.log('Changes to save:', JSON.stringify(changes, null, 2));
            
            try {
                showToast('กำลังบันทึกข้อมูล...', 'info');
                
                const response = await fetch(API_BASE_URL + '/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const projectId = result.projectId || currentProjectId;
                    
                    // Upload files if any
                    const proposalFile = document.getElementById('proposalFile').files[0];
                    const reportFile = document.getElementById('reportFile').files[0];
                    
                    if (proposalFile || reportFile) {
                        const uploadResult = await uploadFiles(projectId);
                        if (!uploadResult.success) {
                            showToast('บันทึกโครงการสำเร็จ แต่อัปโหลดไฟล์ไม่สำเร็จ', 'warning');
                        }
                    }
                    
                    localStorage.setItem('sroiData', JSON.stringify(data));
                    showToast('บันทึกข้อมูลลง Server สำเร็จ', 'success');
                } else {
                    throw new Error(result.message || 'บันทึกข้อมูลไม่สำเร็จ');
                }
            } catch (error) {
                console.error('Save Error:', error);
                localStorage.setItem('sroiData', JSON.stringify(data));
                showToast('ไม่สามารถเชื่อมต่อ Server ได้ - บันทึกใน Local แทน', 'warning');
            }
        }

        async function loadSavedData() {
            // Demo mode - ไม่โหลดข้อมูลจาก server
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                console.log('Demo mode - ไม่โหลดข้อมูลจาก server');
                return;
            }
            
            // ถ้าไม่มี projectId = โครงการใหม่ ไม่ต้องโหลดข้อมูล
            if (!currentProjectId) {
                console.log('โครงการใหม่ - ไม่มีข้อมูลให้โหลด');
                return;
            }
            
            try {
                // เพิ่ม timestamp เพื่อป้องกัน cache
                const timestamp = new Date().getTime();
                const response = await fetch(API_BASE_URL + '/load?projectId=' + currentProjectId + '&_t=' + timestamp, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    applyLoadedData(result.data);
                    console.log('โหลดข้อมูลโครงการ ID:', currentProjectId, 'สำเร็จ');
                    return;
                }
            } catch (error) {
                console.log('ไม่สามารถโหลดจาก Server:', error.message);
            }
            
            // Fallback to localStorage (backward compatibility)
            const savedData = localStorage.getItem('sroiData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    applyLoadedData(data);
                    console.log('โหลดข้อมูลจาก Local Storage');
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }
        
        function applyLoadedData(data) {
            console.log('=== Loading Data ===');
            console.log('Raw data:', JSON.stringify(data, null, 2));
            
            if (data.project) {
                document.getElementById('projectName').value = data.project.name || '';
                document.getElementById('recorderName').value = data.project.recorderName || '';
                document.getElementById('budget').value = data.project.budget || '';
                document.getElementById('objectives').value = data.project.objectives || '';
                document.getElementById('expectedResults').value = data.project.expectedResults || '';
                document.getElementById('phoneNumber').value = data.project.phoneNumber || '';
                
                // โหลดวันที่กลับมาแสดงใน Thai date picker (เฉพาะเมื่อมีค่า)
                // ถ้าไม่มีค่า ให้ใช้ค่า default ที่ตั้งไว้ใน setDefaultDate()
                if (data.project.recordDate) {
                    document.getElementById('recordDate').value = data.project.recordDate;
                    loadDateToThaiPicker('recordDate', data.project.recordDate);
                }
                if (data.project.startDate) {
                    document.getElementById('startDate').value = data.project.startDate;
                    loadDateToThaiPicker('startDate', data.project.startDate);
                }
                if (data.project.endDate) {
                    document.getElementById('endDate').value = data.project.endDate;
                    loadDateToThaiPicker('endDate', data.project.endDate);
                }
                
                // แสดงไฟล์แนบที่มีอยู่
                if (data.project.proposalFile) {
                    document.getElementById('proposalFilePreview').style.display = 'flex';
                    document.getElementById('proposalFileName').textContent = data.project.proposalFile + ' (บันทึกแล้ว)';
                }
                if (data.project.reportFile) {
                    document.getElementById('reportFilePreview').style.display = 'flex';
                    document.getElementById('reportFileName').textContent = data.project.reportFile + ' (บันทึกแล้ว)';
                }
                
                // ===== แก้ไข: Set ค่า Dropdown 4 ตัว =====
                if (data.project.projectType) {
                    setDropdownValue('projectType', 'projectTypeOther', 'projectTypeOtherValue', data.project.projectType);
                }
                if (data.project.department) {
                    setDropdownValue('department', 'departmentOther', 'departmentOtherValue', data.project.department);
                }
                if (data.project.strategy) {
                    setDropdownValue('strategy', 'strategyOther', 'strategyOtherValue', data.project.strategy);
                }
                if (data.project.evaluationType) {
                    setDropdownValue('evaluationType', 'evaluationTypeOther', 'evaluationTypeOtherValue', data.project.evaluationType);
                }
                // ===== สิ้นสุดการแก้ไข =====
                
                if (data.project.sdgs) {
                    data.project.sdgs.forEach(sdgId => {
                        const cb = document.querySelector(`input[name="sdg"][value="${sdgId}"]`);
                        if (cb) {
                            cb.checked = true;
                            cb.closest('.sdg-item').classList.add('selected');
                        }
                    });
                }
            }
            
            stakeholders = data.stakeholders || [];
            
            // ===== แก้ไขปัญหา: ตรวจสอบข้อมูล changes และเพิ่มค่าเริ่มต้นที่ขาดหาย =====
            changes = (data.changes || []).map(change => {
                // ตรวจสอบและเพิ่มโครงสร้างข้อมูลที่ขาดหาย
                if (!change.outcome) {
                    change.outcome = {};
                }
                if (!change.outcome.values) {
                    change.outcome.values = {
                        Y0: 0,
                        Y1: 0,
                        Y2: 0,
                        Y3: 0,
                        Y4: 0,
                        Y5: 0
                    };
                }
                if (!change.adjust) {
                    change.adjust = {};
                }
                if (!change.adjust.dropoff) {
                    change.adjust.dropoff = [0, 0, 0, 0, 0];
                }
                return change;
            });
            
            console.log('Changes after loading:', JSON.stringify(changes, null, 2));
            // ===== สิ้นสุดการแก้ไข =====
            
            sroiResult = data.sroiResult || null;
            
            // Debug: แสดงค่า sroiResult ที่โหลดมา
            console.log('=== Loading SROI Result ===');
            console.log('sroiResult from server:', sroiResult);
            
            renderStakeholderTable();
            renderChangesTable();
            
            // แสดง Outcome Mapping ทันทีเมื่อโหลดข้อมูล (ไม่ต้องกดคำนวณ SROI)
            if (changes.length > 0) {
                updateOutcomeMapping();
            }
            
            // แสดงผล SROI Result ที่บันทึกไว้ (ไม่ต้องกดคำนวณใหม่)
            if (sroiResult && sroiResult.sroiRatio !== undefined && sroiResult.sroiRatio !== null) {
                console.log('✅ Displaying saved SROI Result:', sroiResult.sroiRatio);
                document.getElementById('sroiRatio').textContent = Number(sroiResult.sroiRatio).toFixed(2);
                document.getElementById('totalPV').textContent = formatNumber(sroiResult.totalPresentValue || 0);
                document.getElementById('totalInvestment').textContent = formatNumber(sroiResult.totalInvestment || 0);
                document.getElementById('netBenefit').textContent = formatNumber(sroiResult.netBenefit || 0);
                updateSummary();
            } else {
                console.log('⚠️ No SROI Result found in loaded data');
            }
        }
        
        // ===== ฟังก์ชันใหม่: ตั้งค่า Dropdown =====
        function setDropdownValue(selectId, containerId, inputId, value) {
            const select = document.getElementById(selectId);
            if (!select || !value) return;
            
            // ลองหาค่าใน dropdown options
            let found = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === value) {
                    select.value = value;
                    found = true;
                    break;
                }
            }
            
            // ถ้าไม่พบในตัวเลือก ให้เลือก "other" และใส่ค่าในช่อง input
            if (!found && value !== '') {
                select.value = 'other';
                const container = document.getElementById(containerId);
                const input = document.getElementById(inputId);
                if (container) container.classList.add('show');
                if (input) input.value = value;
            }
        }
        // ===== สิ้นสุดฟังก์ชันใหม่ =====

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Demo mode - แสดงระบบทันทีโดยไม่ต้อง login
            if (typeof DEMO_MODE !== 'undefined' && DEMO_MODE) {
                console.log('🎮 Demo Mode - เริ่มต้นระบบทดลองใช้งาน');
                // แสดง demo banner
                showDemoBanner();
            }
            
            initializeDropdowns();
            initializeSDGs();
            initializeDatePickers();
            setDefaultDate();
            loadSavedData();
        });
        
        // แสดง Demo Banner
        function showDemoBanner() {
            const banner = document.createElement('div');
            banner.id = 'demo-banner';
            banner.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 500; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                    <i class="fas fa-gamepad"></i> โหมดทดลองใช้งาน (Demo Mode) - ข้อมูลจะไม่ถูกบันทึก | 
                    <a href="https://sroi.kku.ac.th" style="color: #ffd700; text-decoration: underline;">เข้าสู่ระบบจริง</a>
                </div>
            `;
            document.body.insertBefore(banner, document.body.firstChild);
            
            // เพิ่ม margin-top ให้ header
            const header = document.querySelector('.header');
            if (header) {
                header.style.marginTop = '48px';
            }
        }

        // ===== LANGUAGE TOGGLE SYSTEM =====
        let currentLanguage = 'th';
        let googleTranslateReady = false;

        function loadGoogleTranslate() {
            var script = document.createElement('script');
            script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
            document.head.appendChild(script);
        }
        loadGoogleTranslate();

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'th',
                includedLanguages: 'en',
                autoDisplay: false
            }, 'google_translate_element');
            
            setTimeout(function() {
                googleTranslateReady = true;
            }, 500);
        }

        function toggleLanguage() {
            if (currentLanguage === 'th') {
                if (!googleTranslateReady) {
                    setTimeout(function() {
                        toggleLanguage();
                    }, 500);
                    return;
                }
                var select = document.querySelector('select.goog-te-combo');
                if (select) {
                    select.value = 'en';
                    select.dispatchEvent(new Event('change'));
                    currentLanguage = 'en';
                    updateLangButton();
                }
            } else {
                localStorage.setItem('sroiStayLoggedIn', 'true');
                
                document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
                document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=' + location.hostname;
                document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.' + location.hostname;
                
                var gtElems = document.querySelectorAll('.goog-te-banner-frame, .goog-te-menu-frame, .skiptranslate');
                gtElems.forEach(function(el) { el.remove(); });
                
                document.documentElement.classList.remove('translated-ltr', 'translated-rtl');
                
                location.reload(true);
            }
        }

        function updateLangButton() {
            var langText = document.getElementById('langText');
            var langBtn = document.getElementById('langToggleBtn');
            if (currentLanguage === 'en') {
                langText.textContent = 'TH';
                langBtn.title = 'กลับภาษาไทย';
            } else {
                langText.textContent = 'EN';
                langBtn.title = 'Switch to English';
            }
        }

        // ===== File Upload Functions =====
        function validatePDF(input, type) {
            const file = input.files[0];
            if (file) {
                if (file.type !== 'application/pdf') {
                    showToast('กรุณาอัปโหลดไฟล์ PDF เท่านั้น', 'error');
                    input.value = '';
                    return false;
                }
                
                // Show file preview
                const preview = document.getElementById(type + 'FilePreview');
                const fileName = document.getElementById(type + 'FileName');
                preview.style.display = 'flex';
                fileName.textContent = file.name;
                return true;
            }
            return false;
        }

        function removeFile(type) {
            const input = document.getElementById(type + 'File');
            const preview = document.getElementById(type + 'FilePreview');
            input.value = '';
            preview.style.display = 'none';
        }

        // ===== Upload Files Function =====
        async function uploadFiles(projectId) {
            const proposalFile = document.getElementById('proposalFile').files[0];
            const reportFile = document.getElementById('reportFile').files[0];
            
            if (!proposalFile && !reportFile) {
                return { success: true };
            }
            
            const formData = new FormData();
            formData.append('projectId', projectId);
            
            if (proposalFile) {
                formData.append('proposalFile', proposalFile);
            }
            if (reportFile) {
                formData.append('reportFile', reportFile);
            }
            
            try {
                const response = await fetch(API_BASE_URL + '/upload-files', {
                    method: 'POST',
                    body: formData
                });
                return await response.json();
            } catch (error) {
                console.error('Upload error:', error);
                return { success: false, error: error.message };
            }
        }
    </script>
</body>
</html>
